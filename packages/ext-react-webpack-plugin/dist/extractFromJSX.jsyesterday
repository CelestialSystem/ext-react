"use strict";

var _babylon = require("babylon");

var _astTraverse = _interopRequireDefault(require("ast-traverse"));

var _generator = _interopRequireDefault(require("@babel/generator"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const MODULE_PATTERN = /^@sencha\/(ext-react.*|ext-\/(classic|modern))$/;

function toXtype(str) {
  return str.toLowerCase().replace(/_/g, '-');
}

module.exports = function extractFromJSX(js, compilation, module) {
  const statements = [];
  const types = {}; // Aliases used for reactify

  const reactifyAliases = new Set([]);
  const ast = (0, _babylon.parse)(js, {
    plugins: ['jsx', 'flow', 'doExpressions', 'objectRestSpread', 'classProperties', 'exportExtensions', 'asyncGenerators', 'functionBind', 'functionSent', 'dynamicImport'],
    sourceType: 'module'
  });

  function addType(varName, reactifyArgNode) {
    //     console.log(varType);console.log(reactifyArgNode);
    if (reactifyArgNode.type === 'StringLiteral') {
      var xtype = toXtype(reactifyArgNode.value);

      if (xtype != 'extreact') {
        types[varName] = {
          xtype: toXtype(reactifyArgNode.value)
        };
      } //console.log(varName)
      //console.log(types[varName])

    } else {
      types[varName] = {
        xclass: js.slice(reactifyArgNode.start, reactifyArgNode.end)
      };
    }
  }

  (0, _astTraverse.default)(ast, {
    pre: function (node) {
      if (node.type == 'VariableDeclarator' && node.init && node.init.type === 'CallExpression' && node.init.callee) {
        if (node.init.callee.name == 'reactify') {
          for (let i = 0; i < node.init.arguments.length; i++) {
            //console.log(node.init.arguments[i].value)
            //              const tagName = node.id.elements[i].name;
            //              if (!tagName) continue;
            const valueNode = node.init.arguments[i];
            if (!valueNode) continue; //console.log(tagName)

            addType(node.init.arguments[i].value, valueNode);
          }
        }
      }

      return; //if (node.type == 'ExpressionStatement') {
      // if(isFile) {
      //   console.log(node.type)
      //   console.log(JSON.stringify(node))
      // }

      if (node.type == 'ImportDeclaration') {
        //console.log(node.type)
        //console.log('node: ' + node.source.value)
        //console.log('option: ' + node.source.value)
        //if (node.source.value.match(MODULE_PATTERN)) {
        if (node.source.value.match('@sencha/')) {
          //console.log('node: ' + node.source.value)
          // look for: import { Grid } from '@sencha/react-modern'
          for (let spec of node.specifiers) {
            types[spec.local.name] = {
              xtype: toXtype(spec.imported.name)
            };
          }
        } else if (node.source.value === `@sencha/ext-react`) {
          // identify local names of reactify based on import { reactify as foo } from '@sencha/ext-react';
          for (let spec of node.specifiers) {
            if (spec.imported.name === 'reactify') {
              reactifyAliases.add(spec.local.name);
            }
          }
        }
      } // Look for reactify calls. Keep track of the names of each component so we can map JSX tags to xtypes and
      // convert props to configs so Sencha Cmd can discover automatic dependencies in the manifest.


      if (node.type == 'VariableDeclarator' && node.init && node.init.type === 'CallExpression' && node.init.callee && reactifyAliases.has(node.init.callee.name)) {
        //console.log(node.type)
        //console.log('VariableDeclarator')
        if (node.id.elements) {
          // example: const [ Panel, Grid ] = reactify('Panel', 'Grid');
          for (let i = 0; i < node.id.elements.length; i++) {
            const tagName = node.id.elements[i].name;
            if (!tagName) continue;
            const valueNode = node.init.arguments[i];
            if (!valueNode) continue;
            addType(tagName, valueNode);
          }
        } else {
          // example: const Grid = reactify('grid');
          const varName = node.id.name;
          const arg = node.init.arguments && node.init.arguments[0] && node.init.arguments[0];
          if (varName && arg) addType(varName, arg);
        }
      } // Convert React.createElement(...) calls to the equivalent Ext.create(...) calls to put in the manifest.


      if (node.type === 'CallExpression' && node.callee.object && node.callee.object.name === 'React' && node.callee.property.name === 'createElement') {
        //console.log(node.type)
        const [tag, props] = node.arguments;
        let type = types[tag.name];

        if (type) {
          let config;

          if (Array.isArray(props.properties)) {
            config = (0, _generator.default)(props).code;

            for (let key in type) {
              config = `{\n  ${key}: '${type[key]}',${config.slice(1)}`;
            }
          } else {
            config = JSON.stringify(type);
          }

          statements.push(`Ext.create(${config})`);
        }
      }
    }
  }); // ensure that all imported classes are present in the build even if they aren't used,
  // otherwise the call to reactify will fail

  for (let key in types) {
    statements.push(`Ext.create(${JSON.stringify(types[key])})`);
  } // console.log('\n\nstatements:')
  // console.log(statements)
  // console.log('\n\n')


  return statements;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9leHRyYWN0RnJvbUpTWC5qcyJdLCJuYW1lcyI6WyJNT0RVTEVfUEFUVEVSTiIsInRvWHR5cGUiLCJzdHIiLCJ0b0xvd2VyQ2FzZSIsInJlcGxhY2UiLCJtb2R1bGUiLCJleHBvcnRzIiwiZXh0cmFjdEZyb21KU1giLCJqcyIsImNvbXBpbGF0aW9uIiwic3RhdGVtZW50cyIsInR5cGVzIiwicmVhY3RpZnlBbGlhc2VzIiwiU2V0IiwiYXN0IiwicGx1Z2lucyIsInNvdXJjZVR5cGUiLCJhZGRUeXBlIiwidmFyTmFtZSIsInJlYWN0aWZ5QXJnTm9kZSIsInR5cGUiLCJ4dHlwZSIsInZhbHVlIiwieGNsYXNzIiwic2xpY2UiLCJzdGFydCIsImVuZCIsInByZSIsIm5vZGUiLCJpbml0IiwiY2FsbGVlIiwibmFtZSIsImkiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJ2YWx1ZU5vZGUiLCJzb3VyY2UiLCJtYXRjaCIsInNwZWMiLCJzcGVjaWZpZXJzIiwibG9jYWwiLCJpbXBvcnRlZCIsImFkZCIsImhhcyIsImlkIiwiZWxlbWVudHMiLCJ0YWdOYW1lIiwiYXJnIiwib2JqZWN0IiwicHJvcGVydHkiLCJ0YWciLCJwcm9wcyIsImNvbmZpZyIsIkFycmF5IiwiaXNBcnJheSIsInByb3BlcnRpZXMiLCJjb2RlIiwia2V5IiwiSlNPTiIsInN0cmluZ2lmeSIsInB1c2giXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBQ0EsTUFBTUEsY0FBYyxHQUFHLGlEQUF2Qjs7QUFFQSxTQUFTQyxPQUFULENBQWlCQyxHQUFqQixFQUFzQjtBQUNsQixTQUFPQSxHQUFHLENBQUNDLFdBQUosR0FBa0JDLE9BQWxCLENBQTBCLElBQTFCLEVBQWdDLEdBQWhDLENBQVA7QUFDSDs7QUFFREMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCLFNBQVNDLGNBQVQsQ0FBd0JDLEVBQXhCLEVBQTRCQyxXQUE1QixFQUF5Q0osTUFBekMsRUFBaUQ7QUFDOUQsUUFBTUss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QUEsTUFBTSxHQUFJLFFBQU9LLEdBQUksTUFBS3JDLElBQUksQ0FBQ3FDLEdBQUQsQ0FBTSxLQUFJTCxNQUFNLENBQUM1QixLQUFQLENBQWEsQ0FBYixDQUFnQixFQUF4RDtBQUNIO0FBQ0osV0FMRCxNQUtPO0FBQ0g0QixZQUFBQSxNQUFNLEdBQUdNLElBQUksQ0FBQ0MsU0FBTCxDQUFldkMsSUFBZixDQUFUO0FBQ0g7O0FBQ0RWLFVBQUFBLFVBQVUsQ0FBQ2tELElBQVgsQ0FBaUIsY0FBYVIsTUFBTyxHQUFyQztBQUNEO0FBQ0Y7QUFDRjtBQWxHVyxHQUFkLEVBckM4RCxDQTBJOUQ7QUFDQTs7QUFDQSxPQUFLLElBQUlLLEdBQVQsSUFBZ0I5QyxLQUFoQixFQUF1QjtBQUNyQkQsSUFBQUEsVUFBVSxDQUFDa0QsSUFBWCxDQUFpQixjQUFhRixJQUFJLENBQUNDLFNBQUwsQ0FBZWhELEtBQUssQ0FBQzhDLEdBQUQsQ0FBcEIsQ0FBMkIsR0FBekQ7QUFDRCxHQTlJNkQsQ0FnSjlEO0FBQ0E7QUFDQTs7O0FBRUEsU0FBTy9DLFVBQVA7QUFDSCxDQXJKRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuaW1wb3J0IHsgcGFyc2UgfSBmcm9tICdiYWJ5bG9uJztcbmltcG9ydCB0cmF2ZXJzZSBmcm9tICdhc3QtdHJhdmVyc2UnO1xuaW1wb3J0IGdlbmVyYXRlIGZyb20gJ0BiYWJlbC9nZW5lcmF0b3InO1xuY29uc3QgTU9EVUxFX1BBVFRFUk4gPSAvXkBzZW5jaGFcXC8oZXh0LXJlYWN0Lip8ZXh0LVxcLyhjbGFzc2ljfG1vZGVybikpJC87XG5cbmZ1bmN0aW9uIHRvWHR5cGUoc3RyKSB7XG4gICAgcmV0dXJuIHN0ci50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL18vZywgJy0nKTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBleHRyYWN0RnJvbUpTWChqcywgY29tcGlsYXRpb24sIG1vZHVsZSkge1xuICAgIGNvbnN0IHN0YXRlbWVudHMgPSBbXTtcbiAgICBjb25zdCB0eXBlcyA9IHt9O1xuXG4gICAgLy8gQWxpYXNlcyB1c2VkIGZvciByZWFjdGlmeVxuICAgIGNvbnN0IHJlYWN0aWZ5QWxpYXNlcyA9IG5ldyBTZXQoW10pO1xuXG4gICAgY29uc3QgYXN0ID0gcGFyc2UoanMsIHtcbiAgICAgICAgcGx1Z2luczogW1xuICAgICAgICAgICAgJ2pzeCcsXG4gICAgICAgICAgICAnZmxvdycsXG4gICAgICAgICAgICAnZG9FeHByZXNzaW9ucycsXG4gICAgICAgICAgICAnb2JqZWN0UmVzdFNwcmVhZCcsXG4gICAgICAgICAgICAnY2xhc3NQcm9wZXJ0aWVzJyxcbiAgICAgICAgICAgICdleHBvcnRFeHRlbnNpb25zJyxcbiAgICAgICAgICAgICdhc3luY0dlbmVyYXRvcnMnLFxuICAgICAgICAgICAgJ2Z1bmN0aW9uQmluZCcsXG4gICAgICAgICAgICAnZnVuY3Rpb25TZW50JyxcbiAgICAgICAgICAgICdkeW5hbWljSW1wb3J0J1xuICAgICAgICBdLFxuICAgICAgICBzb3VyY2VUeXBlOiAnbW9kdWxlJ1xuICAgIH0pO1xuXG4gICAgZnVuY3Rpb24gYWRkVHlwZSh2YXJOYW1lLCByZWFjdGlmeUFyZ05vZGUpIHtcbi8vICAgICBjb25zb2xlLmxvZyh2YXJUeXBlKTtjb25zb2xlLmxvZyhyZWFjdGlmeUFyZ05vZGUpO1xuICAgICAgaWYgKHJlYWN0aWZ5QXJnTm9kZS50eXBlID09PSAnU3RyaW5nTGl0ZXJhbCcpIHtcbiAgICAgICAgICB2YXIgeHR5cGUgPSB0b1h0eXBlKHJlYWN0aWZ5QXJnTm9kZS52YWx1ZSlcbiAgICAgICAgICBpZiAoeHR5cGUgIT0gJ2V4dHJlYWN0Jykge1xuICAgICAgICAgICAgdHlwZXNbdmFyTmFtZV0gPSB7IHh0eXBlOiB0b1h0eXBlKHJlYWN0aWZ5QXJnTm9kZS52YWx1ZSkgfVxuICAgICAgICAgIH1cbiAgICAgICAgICAvL2NvbnNvbGUubG9nKHZhck5hbWUpXG4gICAgICAgICAgLy9jb25zb2xlLmxvZyh0eXBlc1t2YXJOYW1lXSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdHlwZXNbdmFyTmFtZV0gPSB7IHhjbGFzczoganMuc2xpY2UocmVhY3RpZnlBcmdOb2RlLnN0YXJ0LCByZWFjdGlmeUFyZ05vZGUuZW5kKSB9O1xuICAgICAgfVxuICAgIH1cblxuICAgIHRyYXZlcnNlKGFzdCwge1xuICAgICAgcHJlOiBmdW5jdGlvbihub2RlKSB7XG4gICAgICAgIGlmIChub2RlLnR5cGUgPT0gJ1ZhcmlhYmxlRGVjbGFyYXRvcicgXG4gICAgICAgICAgICAmJiBub2RlLmluaXQgXG4gICAgICAgICAgICAmJiBub2RlLmluaXQudHlwZSA9PT0gJ0NhbGxFeHByZXNzaW9uJyBcbiAgICAgICAgICAgICYmIG5vZGUuaW5pdC5jYWxsZWUgXG4gICAgICAgICkge1xuICAgICAgICAgIGlmIChub2RlLmluaXQuY2FsbGVlLm5hbWUgPT0gJ3JlYWN0aWZ5Jykge1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLmluaXQuYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgIC8vY29uc29sZS5sb2cobm9kZS5pbml0LmFyZ3VtZW50c1tpXS52YWx1ZSlcbi8vICAgICAgICAgICAgICBjb25zdCB0YWdOYW1lID0gbm9kZS5pZC5lbGVtZW50c1tpXS5uYW1lO1xuLy8gICAgICAgICAgICAgIGlmICghdGFnTmFtZSkgY29udGludWU7XG4gICAgICAgICAgICAgIGNvbnN0IHZhbHVlTm9kZSA9IG5vZGUuaW5pdC5hcmd1bWVudHNbaV07XG4gICAgICAgICAgICAgIGlmICghdmFsdWVOb2RlKSBjb250aW51ZTtcbiAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyh0YWdOYW1lKVxuICAgICAgICAgICAgICBhZGRUeXBlKG5vZGUuaW5pdC5hcmd1bWVudHNbaV0udmFsdWUsIHZhbHVlTm9kZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm5cblxuXG5cbiAgICAgICAgLy9pZiAobm9kZS50eXBlID09ICdFeHByZXNzaW9uU3RhdGVtZW50Jykge1xuICAgICAgICAvLyBpZihpc0ZpbGUpIHtcbiAgICAgICAgLy8gICBjb25zb2xlLmxvZyhub2RlLnR5cGUpXG4gICAgICAgIC8vICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkobm9kZSkpXG4gICAgICAgIC8vIH1cbiAgICAgICAgaWYgKG5vZGUudHlwZSA9PSAnSW1wb3J0RGVjbGFyYXRpb24nKSB7XG4gICAgICAgICAgLy9jb25zb2xlLmxvZyhub2RlLnR5cGUpXG4gICAgICAgICAgLy9jb25zb2xlLmxvZygnbm9kZTogJyArIG5vZGUuc291cmNlLnZhbHVlKVxuICAgICAgICAgIC8vY29uc29sZS5sb2coJ29wdGlvbjogJyArIG5vZGUuc291cmNlLnZhbHVlKVxuICAgICAgICAgICAgLy9pZiAobm9kZS5zb3VyY2UudmFsdWUubWF0Y2goTU9EVUxFX1BBVFRFUk4pKSB7XG4gICAgICAgICAgICBpZiAobm9kZS5zb3VyY2UudmFsdWUubWF0Y2goJ0BzZW5jaGEvJykpIHtcbiAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZygnbm9kZTogJyArIG5vZGUuc291cmNlLnZhbHVlKVxuICAgICAgICAgICAgICAvLyBsb29rIGZvcjogaW1wb3J0IHsgR3JpZCB9IGZyb20gJ0BzZW5jaGEvcmVhY3QtbW9kZXJuJ1xuICAgICAgICAgICAgICAgIGZvciAobGV0IHNwZWMgb2Ygbm9kZS5zcGVjaWZpZXJzKSB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGVzW3NwZWMubG9jYWwubmFtZV0gPSB7IHh0eXBlOiB0b1h0eXBlKHNwZWMuaW1wb3J0ZWQubmFtZSkgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuc291cmNlLnZhbHVlID09PSBgQHNlbmNoYS9leHQtcmVhY3RgKSB7XG4gICAgICAgICAgICAgICAgLy8gaWRlbnRpZnkgbG9jYWwgbmFtZXMgb2YgcmVhY3RpZnkgYmFzZWQgb24gaW1wb3J0IHsgcmVhY3RpZnkgYXMgZm9vIH0gZnJvbSAnQHNlbmNoYS9leHQtcmVhY3QnO1xuICAgICAgICAgICAgICAgIGZvciAobGV0IHNwZWMgb2Ygbm9kZS5zcGVjaWZpZXJzKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzcGVjLmltcG9ydGVkLm5hbWUgPT09ICdyZWFjdGlmeScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWN0aWZ5QWxpYXNlcy5hZGQoc3BlYy5sb2NhbC5uYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIExvb2sgZm9yIHJlYWN0aWZ5IGNhbGxzLiBLZWVwIHRyYWNrIG9mIHRoZSBuYW1lcyBvZiBlYWNoIGNvbXBvbmVudCBzbyB3ZSBjYW4gbWFwIEpTWCB0YWdzIHRvIHh0eXBlcyBhbmRcbiAgICAgICAgLy8gY29udmVydCBwcm9wcyB0byBjb25maWdzIHNvIFNlbmNoYSBDbWQgY2FuIGRpc2NvdmVyIGF1dG9tYXRpYyBkZXBlbmRlbmNpZXMgaW4gdGhlIG1hbmlmZXN0LlxuICAgICAgICBpZiAobm9kZS50eXBlID09ICdWYXJpYWJsZURlY2xhcmF0b3InIFxuICAgICAgICAmJiBub2RlLmluaXQgXG4gICAgICAgICYmIG5vZGUuaW5pdC50eXBlID09PSAnQ2FsbEV4cHJlc3Npb24nIFxuICAgICAgICAmJiBub2RlLmluaXQuY2FsbGVlIFxuICAgICAgICAmJiByZWFjdGlmeUFsaWFzZXMuaGFzKG5vZGUuaW5pdC5jYWxsZWUubmFtZSkpIHtcbiAgICAgICAgICAvL2NvbnNvbGUubG9nKG5vZGUudHlwZSlcbiAgICAgICAgICAvL2NvbnNvbGUubG9nKCdWYXJpYWJsZURlY2xhcmF0b3InKVxuICAgICAgICAgIGlmIChub2RlLmlkLmVsZW1lbnRzKSB7XG4gICAgICAgICAgICAgICAgLy8gZXhhbXBsZTogY29uc3QgWyBQYW5lbCwgR3JpZCBdID0gcmVhY3RpZnkoJ1BhbmVsJywgJ0dyaWQnKTtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUuaWQuZWxlbWVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFnTmFtZSA9IG5vZGUuaWQuZWxlbWVudHNbaV0ubmFtZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0YWdOYW1lKSBjb250aW51ZTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZU5vZGUgPSBub2RlLmluaXQuYXJndW1lbnRzW2ldO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbHVlTm9kZSkgY29udGludWU7XG5cbiAgICAgICAgICAgICAgICAgICAgYWRkVHlwZSh0YWdOYW1lLCB2YWx1ZU5vZGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gZXhhbXBsZTogY29uc3QgR3JpZCA9IHJlYWN0aWZ5KCdncmlkJyk7XG4gICAgICAgICAgICAgICAgY29uc3QgdmFyTmFtZSA9IG5vZGUuaWQubmFtZTtcbiAgICAgICAgICAgICAgICBjb25zdCBhcmcgPSBub2RlLmluaXQuYXJndW1lbnRzICYmIG5vZGUuaW5pdC5hcmd1bWVudHNbMF0gJiYgbm9kZS5pbml0LmFyZ3VtZW50c1swXTtcbiAgICAgICAgICAgICAgICBpZiAodmFyTmFtZSAmJiBhcmcpIGFkZFR5cGUodmFyTmFtZSwgYXJnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENvbnZlcnQgUmVhY3QuY3JlYXRlRWxlbWVudCguLi4pIGNhbGxzIHRvIHRoZSBlcXVpdmFsZW50IEV4dC5jcmVhdGUoLi4uKSBjYWxscyB0byBwdXQgaW4gdGhlIG1hbmlmZXN0LlxuICAgICAgICBpZiAobm9kZS50eXBlID09PSAnQ2FsbEV4cHJlc3Npb24nIFxuICAgICAgICAmJiBub2RlLmNhbGxlZS5vYmplY3QgXG4gICAgICAgICYmIG5vZGUuY2FsbGVlLm9iamVjdC5uYW1lID09PSAnUmVhY3QnIFxuICAgICAgICAmJiBub2RlLmNhbGxlZS5wcm9wZXJ0eS5uYW1lID09PSAnY3JlYXRlRWxlbWVudCcpIHtcbiAgICAgICAgICAvL2NvbnNvbGUubG9nKG5vZGUudHlwZSlcbiAgICAgICAgICBjb25zdCBbdGFnLCBwcm9wc10gPSBub2RlLmFyZ3VtZW50cztcbiAgICAgICAgICBsZXQgdHlwZSA9IHR5cGVzW3RhZy5uYW1lXTtcbiAgICAgICAgICBpZiAodHlwZSkge1xuICAgICAgICAgICAgbGV0IGNvbmZpZztcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHByb3BzLnByb3BlcnRpZXMpKSB7XG4gICAgICAgICAgICAgICAgY29uZmlnID0gZ2VuZXJhdGUocHJvcHMpLmNvZGU7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQga2V5IGluIHR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uZmlnID0gYHtcXG4gICR7a2V5fTogJyR7dHlwZVtrZXldfScsJHtjb25maWcuc2xpY2UoMSl9YDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbmZpZyA9IEpTT04uc3RyaW5naWZ5KHR5cGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3RhdGVtZW50cy5wdXNoKGBFeHQuY3JlYXRlKCR7Y29uZmlnfSlgKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuXG4gICAgLy8gZW5zdXJlIHRoYXQgYWxsIGltcG9ydGVkIGNsYXNzZXMgYXJlIHByZXNlbnQgaW4gdGhlIGJ1aWxkIGV2ZW4gaWYgdGhleSBhcmVuJ3QgdXNlZCxcbiAgICAvLyBvdGhlcndpc2UgdGhlIGNhbGwgdG8gcmVhY3RpZnkgd2lsbCBmYWlsXG4gICAgZm9yIChsZXQga2V5IGluIHR5cGVzKSB7XG4gICAgICBzdGF0ZW1lbnRzLnB1c2goYEV4dC5jcmVhdGUoJHtKU09OLnN0cmluZ2lmeSh0eXBlc1trZXldKX0pYClcbiAgICB9XG5cbiAgICAvLyBjb25zb2xlLmxvZygnXFxuXFxuc3RhdGVtZW50czonKVxuICAgIC8vIGNvbnNvbGUubG9nKHN0YXRlbWVudHMpXG4gICAgLy8gY29uc29sZS5sb2coJ1xcblxcbicpXG5cbiAgICByZXR1cm4gc3RhdGVtZW50c1xufTtcbiJdfQ==