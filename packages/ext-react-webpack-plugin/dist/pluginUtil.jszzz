"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.log = log;
exports._getApp = _getApp;
exports._getVersions = _getVersions;
exports._prepareForBuild = _prepareForBuild;
exports._buildExtBundle = _buildExtBundle;
exports.executeAsync = executeAsync;

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

var chalk = require('chalk');

const fs = require('fs');

const crossSpawn = require('cross-spawn');

var prefix = ``;

if (require('os').platform() == 'darwin') {
  prefix = `ℹ ｢ext｣:`;
} else {
  prefix = `i [ext]:`;
}

const app = `${chalk.green(prefix)} ext-build:`;
const DEFAULT_SUBSTRS = ['[INF] Loading', '[LOG] Fashion build complete', '[ERR]', '[WRN]', '[INF] Processing', "[INF] Server", "[INF] Writing", "[INF] Loading Build", "[INF] Waiting", "[LOG] Fashion waiting"];

function log(s) {
  require('readline').cursorTo(process.stdout, 0);

  process.stdout.clearLine();
  process.stdout.write(s);
  process.stdout.write('\n');
}

function _getApp(pluginName) {
  var prefix = ``;

  const platform = require('os').platform();

  if (platform == 'darwin') {
    prefix = `ℹ ｢ext｣:`;
  } else {
    prefix = `i [ext]:`;
  }

  return `${chalk.green(prefix)} ${pluginName}: `;
}

function _getVersions(app, pluginName, frameworkName) {
  const path = require('path');

  var v = {};
  var pluginPath = path.resolve(process.cwd(), 'node_modules/@sencha', pluginName);
  var pluginPkg = fs.existsSync(pluginPath + '/package.json') && JSON.parse(fs.readFileSync(pluginPath + '/package.json', 'utf-8')) || {};
  v.pluginVersion = pluginPkg.version;
  var webpackPath = path.resolve(process.cwd(), 'node_modules/webpack');
  var webpackPkg = fs.existsSync(webpackPath + '/package.json') && JSON.parse(fs.readFileSync(webpackPath + '/package.json', 'utf-8')) || {};
  v.webpackVersion = webpackPkg.version;
  var extPath = path.resolve(process.cwd(), 'node_modules/@sencha/ext');
  var extPkg = fs.existsSync(extPath + '/package.json') && JSON.parse(fs.readFileSync(extPath + '/package.json', 'utf-8')) || {};
  v.extVersion = extPkg.sencha.version;
  var cmdPath = path.resolve(pluginPath, 'node_modules/@sencha/cmd');
  var cmdPkg = fs.existsSync(cmdPath + '/package.json') && JSON.parse(fs.readFileSync(cmdPath + '/package.json', 'utf-8')) || {};
  v.cmdVersion = cmdPkg.version_full;
  var frameworkInfo = '';

  if (frameworkName != undefined && frameworkName != 'extjs') {
    var frameworkPath = path.resolve(process.cwd(), 'node_modules', frameworkName);
    var frameworkPkg = fs.existsSync(frameworkPath + '/package.json') && JSON.parse(fs.readFileSync(frameworkPath + '/package.json', 'utf-8')) || {};
    v.frameworkVersion = frameworkPkg.version;
    frameworkInfo = ', ' + frameworkName + ' v' + v.frameworkVersion;
  }

  return app + 'v' + v.pluginVersion + ', Ext JS v' + v.extVersion + ', Sencha Cmd v' + v.cmdVersion + ', Webpack v' + v.webpackVersion + frameworkInfo;
}

function _getSenchCmdPath() {
  try {
    return require('@sencha/cmd');
  } catch (e) {
    return 'sencha';
  }
}

function _prepareForBuild(app, vars, options, output, compilation) {
  const log = require('./pluginUtil').log;

  const buildXML = require('./artifacts').buildXML;

  const createAppJson = require('./artifacts').createAppJson;

  const createWorkspaceJson = require('./artifacts').createWorkspaceJson;

  const createJSDOMEnvironment = require('./artifacts').createJSDOMEnvironment;

  const rimraf = require('rimraf');

  const mkdirp = require('mkdirp');

  const fsx = require('fs-extra');

  const fs = require('fs');

  const path = require('path');

  var packages = options.packages;
  var toolkit = options.toolkit;
  var theme = options.theme;
  theme = theme || (toolkit === 'classic' ? 'theme-triton' : 'theme-material');

  if (vars.firstTime) {
    rimraf.sync(output);
    mkdirp.sync(output);
    fs.writeFileSync(path.join(output, 'build.xml'), buildXML({
      compress: vars.production
    }), 'utf8');
    fs.writeFileSync(path.join(output, 'jsdom-environment.js'), createJSDOMEnvironment(), 'utf8');
    fs.writeFileSync(path.join(output, 'app.json'), createAppJson(theme, packages, toolkit), 'utf8');
    fs.writeFileSync(path.join(output, 'workspace.json'), createWorkspaceJson(), 'utf8');

    if (fs.existsSync(path.join(process.cwd(), options.output + '/packages/'))) {
      var fromPackages = path.join(process.cwd(), options.output + '/packages/');
      var toPackages = path.join(output, 'packages/');
      fsx.copySync(fromPackages, toPackages);
      log(app + 'copying ' + fromPackages.replace(process.cwd(), '') + ' to: ' + toPackages.replace(process.cwd(), ''));
    }

    if (fs.existsSync(path.join(process.cwd(), 'resources/'))) {
      var fromResources = path.join(process.cwd(), 'resources/');
      var toResources = path.join(output, '../resources');
      fsx.copySync(fromResources, toResources);
      log(app + 'copying ' + fromResources.replace(process.cwd(), '') + ' to: ' + toResources.replace(process.cwd(), ''));
    }

    if (fs.existsSync(path.join(process.cwd(), options.output + '/overrides/'))) {
      var fromOverrides = path.join(process.cwd(), options.output + '/overrides/');
      var toOverrides = path.join(output, 'overrides/');
      fsx.copySync(fromOverrides, toOverrides);
      log(app + 'copying ' + fromOverrides.replace(process.cwd(), '') + ' to: ' + toOverrides.replace(process.cwd(), ''));
    }
  }

  vars.firstTime = false;
  let js;

  if (vars.production) {
    vars.deps.push('Ext.require("Ext.layout.*");\n');
    js = vars.deps.join(';\n');
  } else {
    js = 'Ext.require("Ext.*")';
  }

  if (vars.manifest === null || js !== vars.manifest) {
    vars.manifest = js;
    const manifest = path.join(output, 'manifest.js');
    fs.writeFileSync(manifest, js, 'utf8');
    vars.rebuild = true;
    log(app + 'building ExtReact bundle at: ' + output.replace(process.cwd(), ''));
  } else {
    vars.rebuild = false;
    log(app + 'ExtReact rebuild NOT needed');
  }
}

function _buildExtBundle(compilation, cmdErrors, output, parms, options) {
  let sencha = _getSenchCmdPath();

  return new Promise((resolve, reject) => {
    const onBuildDone = () => {
      if (cmdErrors.length) {
        reject(new Error(cmdErrors.join("")));
      } else {
        resolve();
      }
    };

    var opts = {
      cwd: output,
      silent: true,
      stdio: 'pipe',
      encoding: 'utf-8'
    };
    executeAsync(sencha, parms, opts, compilation, cmdErrors, options.verbose).then(function () {
      onBuildDone();
    }, function (reason) {
      resolve(reason);
    });
  });
}

function executeAsync(_x, _x2, _x3, _x4, _x5) {
  return _executeAsync.apply(this, arguments);
}

function _executeAsync() {
  _executeAsync = _asyncToGenerator(
  /*#__PURE__*/
  regeneratorRuntime.mark(function _callee(command, parms, options, compilation, cmdErrors, verbose = 'no', substrings = DEFAULT_SUBSTRS) {
    return regeneratorRuntime.wrap(function _callee$(_context) {
      while (1) switch (_context.prev = _context.next) {
        case 0:
          _context.next = 2;
          return new Promise((resolve, reject) => {
            if (verbose == 'yes') {
              console.log(`-v-${app} command - ${command}`);
              console.log(`-v-${app} parms - ${parms}`);
              console.log(`-v-${app} options - ${JSON.stringify(options)}`);
            }

            let child = crossSpawn(command, parms, options);
            child.on('close', (code, signal) => {
              if (code === 0) {
                resolve(0);
              } else {
                compilation.errors.push(new Error(cmdErrors.join("")));
                reject(0);
              }
            });
            child.on('error', error => {
              reject(error);
            });
            child.stdout.on('data', data => {
              var str = data.toString().replace(/\r?\n|\r/g, " ").trim();

              if (data && data.toString().match(/Waiting for changes\.\.\./)) {
                resolve(0);
              }

              if (verbose == 'yes') {
                console.log(`-v-${app}${str}`);
              } else {
                if (substrings.some(function (v) {
                  return data.indexOf(v) >= 0;
                })) {
                  str = str.replace("[INF]", "");
                  str = str.replace("[LOG]", "");
                  str = str.replace(process.cwd(), '');

                  if (str.includes("[ERR]")) {
                    cmdErrors.push(app + str.replace(/^\[ERR\] /gi, ''));
                    str = str.replace("[ERR]", `${chalk.red("[ERR]")}`);
                  }

                  console.log(`${app}${str}`);
                }
              }
            });
            child.stderr.on('data', data => {
              var str = data.toString().replace(/\r?\n|\r/g, " ").trim();
              var strJavaOpts = "Picked up _JAVA_OPTIONS";
              var includes = str.includes(strJavaOpts);

              if (!includes) {
                console.log(`${app} ${chalk.red("[ERR]")} ${str}`);
              }
            });
          });

        case 2:
        case "end":
          return _context.stop();
      }
    }, _callee, this);
  }));
  return _executeAsync.apply(this, arguments);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9wbHVnaW5VdGlsLmpzIl0sIm5hbWVzIjpbImNoYWxrIiwicmVxdWlyZSIsImZzIiwiY3Jvc3NTcGF3biIsInByZWZpeCIsInBsYXRmb3JtIiwiYXBwIiwiZ3JlZW4iLCJERUZBVUxUX1NVQlNUUlMiLCJsb2ciLCJzIiwiY3Vyc29yVG8iLCJwcm9jZXNzIiwic3Rkb3V0IiwiY2xlYXJMaW5lIiwid3JpdGUiLCJfZ2V0QXBwIiwicGx1Z2luTmFtZSIsIl9nZXRWZXJzaW9ucyIsImZyYW1ld29ya05hbWUiLCJwYXRoIiwidiIsInBsdWdpblBhdGgiLCJyZXNvbHZlIiwiY3dkIiwicGx1Z2luUGtnIiwiZXhpc3RzU3luYyIsIkpTT04iLCJwYXJzZSIsInJlYWRGaWxlU3luYyIsInBsdWdpblZlcnNpb24iLCJ2ZXJzaW9uIiwid2VicGFja1BhdGgiLCJ3ZWJwYWNrUGtnIiwid2VicGFja1ZlcnNpb24iLCJleHRQYXRoIiwiZXh0UGtnIiwiZXh0VmVyc2lvbiIsInNlbmNoYSIsImNtZFBhdGgiLCJjbWRQa2ciLCJjbWRWZXJzaW9uIiwidmVyc2lvbl9mdWxsIiwiZnJhbWV3b3JrSW5mbyIsInVuZGVmaW5lZCIsImZyYW1ld29ya1BhdGgiLCJmcmFtZXdvcmtQa2ciLCJmcmFtZXdvcmtWZXJzaW9uIiwiX2dldFNlbmNoQ21kUGF0aCIsImUiLCJfcHJlcGFyZUZvckJ1aWxkIiwidmFycyIsIm9wdGlvbnMiLCJvdXRwdXQiLCJjb21waWxhdGlvbiIsImJ1aWxkWE1MIiwiY3JlYXRlQXBwSnNvbiIsImNyZWF0ZVdvcmtzcGFjZUpzb24iLCJjcmVhdGVKU0RPTUVudmlyb25tZW50IiwicmltcmFmIiwibWtkaXJwIiwiZnN4IiwicGFja2FnZXMiLCJ0b29sa2l0IiwidGhlbWUiLCJmaXJzdFRpbWUiLCJzeW5jIiwid3JpdGVGaWxlU3luYyIsImpvaW4iLCJjb21wcmVzcyIsInByb2R1Y3Rpb24iLCJmcm9tUGFja2FnZXMiLCJ0b1BhY2thZ2VzIiwiY29weVN5bmMiLCJyZXBsYWNlIiwiZnJvbVJlc291cmNlcyIsInRvUmVzb3VyY2VzIiwiZnJvbU92ZXJyaWRlcyIsInRvT3ZlcnJpZGVzIiwianMiLCJkZXBzIiwicHVzaCIsIm1hbmlmZXN0IiwicmVidWlsZCIsIl9idWlsZEV4dEJ1bmRsZSIsImNtZEVycm9ycyIsInBhcm1zIiwiUHJvbWlzZSIsInJlamVjdCIsIm9uQnVpbGREb25lIiwibGVuZ3RoIiwiRXJyb3IiLCJvcHRzIiwic2lsZW50Iiwic3RkaW8iLCJlbmNvZGluZyIsImV4ZWN1dGVBc3luYyIsInZlcmJvc2UiLCJ0aGVuIiwicmVhc29uIiwiY29tbWFuZCIsInN1YnN0cmluZ3MiLCJjb25zb2xlIiwic3RyaW5naWZ5IiwiY2hpbGQiLCJvbiIsImNvZGUiLCJzaWduYWwiLCJlcnJvcnMiLCJlcnJvciIsImRhdGEiLCJzdHIiLCJ0b1N0cmluZyIsInRyaW0iLCJtYXRjaCIsInNvbWUiLCJpbmRleE9mIiwiaW5jbHVkZXMiLCJyZWQiLCJzdGRlcnIiLCJzdHJKYXZhT3B0cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLElBQUlBLEtBQUssR0FBR0MsT0FBTyxDQUFDLE9BQUQsQ0FBbkI7O0FBQ0EsTUFBTUMsRUFBRSxHQUFHRCxPQUFPLENBQUMsSUFBRCxDQUFsQjs7QUFDQSxNQUFNRSxVQUFVLEdBQUdGLE9BQU8sQ0FBQyxhQUFELENBQTFCOztBQUNBLElBQUlHLE1BQU0sR0FBSSxFQUFkOztBQUFnQixJQUFJSCxPQUFPLENBQUMsSUFBRCxDQUFQLENBQWNJLFFBQWQsTUFBNEIsUUFBaEMsRUFBMEM7QUFBQ0QsRUFBQUEsTUFBTSxHQUFJLFVBQVY7QUFBb0IsQ0FBL0QsTUFBcUU7QUFBQ0EsRUFBQUEsTUFBTSxHQUFJLFVBQVY7QUFBb0I7O0FBQzFHLE1BQU1FLEdBQUcsR0FBSSxHQUFFTixLQUFLLENBQUNPLEtBQU4sQ0FBWUgsTUFBWixDQUFvQixhQUFuQztBQUNBLE1BQU1JLGVBQWUsR0FBRyxDQUFDLGVBQUQsRUFBa0IsOEJB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ZixnQkFBQUEsT0FBTyxDQUFDN0YsR0FBUixDQUFhLEdBQUVILEdBQUksSUFBR04sS0FBSyxDQUFDc0gsR0FBTixDQUFVLE9BQVYsQ0FBbUIsSUFBR1AsR0FBSSxFQUFoRDtBQUNEO0FBQ0YsYUFQRDtBQVFELFdBekNLLENBREQ7O0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBLEciLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgY2hhbGsgPSByZXF1aXJlKCdjaGFsaycpXG5jb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJylcbmNvbnN0IGNyb3NzU3Bhd24gPSByZXF1aXJlKCdjcm9zcy1zcGF3bicpXG52YXIgcHJlZml4ID0gYGA7aWYgKHJlcXVpcmUoJ29zJykucGxhdGZvcm0oKSA9PSAnZGFyd2luJykge3ByZWZpeCA9IGDihLkg772iZXh0772jOmB9IGVsc2Uge3ByZWZpeCA9IGBpIFtleHRdOmB9XG5jb25zdCBhcHAgPSBgJHtjaGFsay5ncmVlbihwcmVmaXgpfSBleHQtYnVpbGQ6YFxuY29uc3QgREVGQVVMVF9TVUJTVFJTID0gWydbSU5GXSBMb2FkaW5nJywgJ1tMT0ddIEZhc2hpb24gYnVpbGQgY29tcGxldGUnLCAnW0VSUl0nLCAnW1dSTl0nLCAnW0lORl0gUHJvY2Vzc2luZycsIFwiW0lORl0gU2VydmVyXCIsIFwiW0lORl0gV3JpdGluZ1wiLCBcIltJTkZdIExvYWRpbmcgQnVpbGRcIiwgXCJbSU5GXSBXYWl0aW5nXCIsIFwiW0xPR10gRmFzaGlvbiB3YWl0aW5nXCJdO1xuXG5leHBvcnQgZnVuY3Rpb24gbG9nKHMpIHtcbiAgcmVxdWlyZSgncmVhZGxpbmUnKS5jdXJzb3JUbyhwcm9jZXNzLnN0ZG91dCwgMClcbiAgcHJvY2Vzcy5zdGRvdXQuY2xlYXJMaW5lKClcbiAgcHJvY2Vzcy5zdGRvdXQud3JpdGUocylcbiAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoJ1xcbicpXG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIF9nZXRBcHAocGx1Z2luTmFtZSkge1xuICB2YXIgcHJlZml4ID0gYGBcbiAgY29uc3QgcGxhdGZvcm0gPSByZXF1aXJlKCdvcycpLnBsYXRmb3JtKClcbiAgaWYgKHBsYXRmb3JtID09ICdkYXJ3aW4nKSB7IHByZWZpeCA9IGDihLkg772iZXh0772jOmAgfVxuICBlbHNlIHsgcHJlZml4ID0gYGkgW2V4dF06YCB9XG4gIHJldHVybiBgJHtjaGFsay5ncmVlbihwcmVmaXgpfSAke3BsdWdpbk5hbWV9OiBgXG59XG5cblxuZXhwb3J0IGZ1bmN0aW9uIF9nZXRWZXJzaW9ucyhhcHAsIHBsdWdpbk5hbWUsIGZyYW1ld29ya05hbWUpIHtcbiAgY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuXG4gIHZhciB2ID0ge31cbiAgdmFyIHBsdWdpblBhdGggPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwnbm9kZV9tb2R1bGVzL0BzZW5jaGEnLCBwbHVnaW5OYW1lKVxuICB2YXIgcGx1Z2luUGtnID0gKGZzLmV4aXN0c1N5bmMocGx1Z2luUGF0aCsnL3BhY2thZ2UuanNvbicpICYmIEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKHBsdWdpblBhdGgrJy9wYWNrYWdlLmpzb24nLCAndXRmLTgnKSkgfHwge30pO1xuICB2LnBsdWdpblZlcnNpb24gPSBwbHVnaW5Qa2cudmVyc2lvblxuXG4gIHZhciB3ZWJwYWNrUGF0aCA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCdub2RlX21vZHVsZXMvd2VicGFjaycpXG4gIHZhciB3ZWJwYWNrUGtnID0gKGZzLmV4aXN0c1N5bmMod2VicGFja1BhdGgrJy9wYWNrYWdlLmpzb24nKSAmJiBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyh3ZWJwYWNrUGF0aCsnL3BhY2thZ2UuanNvbicsICd1dGYtOCcpKSB8fCB7fSk7XG4gIHYud2VicGFja1ZlcnNpb24gPSB3ZWJwYWNrUGtnLnZlcnNpb25cblxuICB2YXIgZXh0UGF0aCA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCdub2RlX21vZHVsZXMvQHNlbmNoYS9leHQnKVxuICB2YXIgZXh0UGtnID0gKGZzLmV4aXN0c1N5bmMoZXh0UGF0aCsnL3BhY2thZ2UuanNvbicpICYmIEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKGV4dFBhdGgrJy9wYWNrYWdlLmpzb24nLCAndXRmLTgnKSkgfHwge30pO1xuICB2LmV4dFZlcnNpb24gPSBleHRQa2cuc2VuY2hhLnZlcnNpb25cblxuICB2YXIgY21kUGF0aCA9IHBhdGgucmVzb2x2ZShwbHVnaW5QYXRoLCdub2RlX21vZHVsZXMvQHNlbmNoYS9jbWQnKVxuICB2YXIgY21kUGtnID0gKGZzLmV4aXN0c1N5bmMoY21kUGF0aCsnL3BhY2thZ2UuanNvbicpICYmIEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKGNtZFBhdGgrJy9wYWNrYWdlLmpzb24nLCAndXRmLTgnKSkgfHwge30pO1xuICB2LmNtZFZlcnNpb24gPSBjbWRQa2cudmVyc2lvbl9mdWxsXG5cbiAgdmFyIGZyYW1ld29ya0luZm8gPSAnJ1xuICBpZiAoZnJhbWV3b3JrTmFtZSAhPSB1bmRlZmluZWQgJiYgZnJhbWV3b3JrTmFtZSAhPSAnZXh0anMnKSB7XG4gICAgdmFyIGZyYW1ld29ya1BhdGggPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwnbm9kZV9tb2R1bGVzJywgZnJhbWV3b3JrTmFtZSlcbiAgICB2YXIgZnJhbWV3b3JrUGtnID0gKGZzLmV4aXN0c1N5bmMoZnJhbWV3b3JrUGF0aCsnL3BhY2thZ2UuanNvbicpICYmIEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKGZyYW1ld29ya1BhdGgrJy9wYWNrYWdlLmpzb24nLCAndXRmLTgnKSkgfHwge30pO1xuICAgIHYuZnJhbWV3b3JrVmVyc2lvbiA9IGZyYW1ld29ya1BrZy52ZXJzaW9uXG4gICAgZnJhbWV3b3JrSW5mbyA9ICcsICcgKyBmcmFtZXdvcmtOYW1lICsgJyB2JyArIHYuZnJhbWV3b3JrVmVyc2lvblxuICB9XG5cbiAgcmV0dXJuIGFwcCArICd2JyArIHYucGx1Z2luVmVyc2lvbiArICcsIEV4dCBKUyB2JyArIHYuZXh0VmVyc2lvbiArICcsIFNlbmNoYSBDbWQgdicgKyB2LmNtZFZlcnNpb24gKyAnLCBXZWJwYWNrIHYnICsgdi53ZWJwYWNrVmVyc2lvbiArIGZyYW1ld29ya0luZm9cbn1cblxuZnVuY3Rpb24gX2dldFNlbmNoQ21kUGF0aCgpIHtcbiAgdHJ5IHsgcmV0dXJuIHJlcXVpcmUoJ0BzZW5jaGEvY21kJykgfSBcbiAgY2F0Y2ggKGUpIHsgcmV0dXJuICdzZW5jaGEnIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF9wcmVwYXJlRm9yQnVpbGQoYXBwLCB2YXJzLCBvcHRpb25zLCBvdXRwdXQsIGNvbXBpbGF0aW9uKSB7XG4gIGNvbnN0IGxvZyA9IHJlcXVpcmUoJy4vcGx1Z2luVXRpbCcpLmxvZ1xuICBjb25zdCBidWlsZFhNTCA9IHJlcXVpcmUoJy4vYXJ0aWZhY3RzJykuYnVpbGRYTUxcbiAgY29uc3QgY3JlYXRlQXBwSnNvbiA9IHJlcXVpcmUoJy4vYXJ0aWZhY3RzJykuY3JlYXRlQXBwSnNvblxuICBjb25zdCBjcmVhdGVXb3Jrc3BhY2VKc29uID0gcmVxdWlyZSgnLi9hcnRpZmFjdHMnKS5jcmVhdGVXb3Jrc3BhY2VKc29uXG4gIGNvbnN0IGNyZWF0ZUpTRE9NRW52aXJvbm1lbnQgPSByZXF1aXJlKCcuL2FydGlmYWN0cycpLmNyZWF0ZUpTRE9NRW52aXJvbm1lbnRcbiAgY29uc3QgcmltcmFmID0gcmVxdWlyZSgncmltcmFmJylcbiAgY29uc3QgbWtkaXJwID0gcmVxdWlyZSgnbWtkaXJwJylcbiAgY29uc3QgZnN4ID0gcmVxdWlyZSgnZnMtZXh0cmEnKVxuICBjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJylcbiAgY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuXG4gIHZhciBwYWNrYWdlcyA9IG9wdGlvbnMucGFja2FnZXNcbiAgdmFyIHRvb2xraXQgPSBvcHRpb25zLnRvb2xraXRcbiAgdmFyIHRoZW1lID0gb3B0aW9ucy50aGVtZVxuXG4gIHRoZW1lID0gdGhlbWUgfHwgKHRvb2xraXQgPT09ICdjbGFzc2ljJyA/ICd0aGVtZS10cml0b24nIDogJ3RoZW1lLW1hdGVyaWFsJylcbiAgaWYgKHZhcnMuZmlyc3RUaW1lKSB7XG4gICAgcmltcmFmLnN5bmMob3V0cHV0KVxuICAgIG1rZGlycC5zeW5jKG91dHB1dClcbiAgICBmcy53cml0ZUZpbGVTeW5jKHBhdGguam9pbihvdXRwdXQsICdidWlsZC54bWwnKSwgYnVpbGRYTUwoeyBjb21wcmVzczogdmFycy5wcm9kdWN0aW9uIH0pLCAndXRmOCcpXG4gICAgZnMud3JpdGVGaWxlU3luYyhwYXRoLmpvaW4ob3V0cHV0LCAnanNkb20tZW52aXJvbm1lbnQuanMnKSwgY3JlYXRlSlNET01FbnZpcm9ubWVudCgpLCAndXRmOCcpXG4gICAgZnMud3JpdGVGaWxlU3luYyhwYXRoLmpvaW4ob3V0cHV0LCAnYXBwLmpzb24nKSwgY3JlYXRlQXBwSnNvbiggdGhlbWUsIHBhY2thZ2VzLCB0b29sa2l0ICksICd1dGY4JylcbiAgICBmcy53cml0ZUZpbGVTeW5jKHBhdGguam9pbihvdXRwdXQsICd3b3Jrc3BhY2UuanNvbicpLCBjcmVhdGVXb3Jrc3BhY2VKc29uKCksICd1dGY4JylcblxuICAgIGlmIChmcy5leGlzdHNTeW5jKHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCBvcHRpb25zLm91dHB1dCArICcvcGFja2FnZXMvJykpKSB7XG4gICAgICB2YXIgZnJvbVBhY2thZ2VzID0gcGF0aC5qb2luKHByb2Nlc3MuY3dkKCksIG9wdGlvbnMub3V0cHV0ICsgJy9wYWNrYWdlcy8nKVxuICAgICAgdmFyIHRvUGFja2FnZXMgPSBwYXRoLmpvaW4ob3V0cHV0LCAncGFja2FnZXMvJylcbiAgICAgIGZzeC5jb3B5U3luYyhmcm9tUGFja2FnZXMsIHRvUGFja2FnZXMpXG4gICAgICBsb2coYXBwICsgJ2NvcHlpbmcgJyArIGZyb21QYWNrYWdlcy5yZXBsYWNlKHByb2Nlc3MuY3dkKCksICcnKSArICcgdG86ICcgKyB0b1BhY2thZ2VzLnJlcGxhY2UocHJvY2Vzcy5jd2QoKSwgJycpKVxuICAgIH1cblxuICAgIGlmIChmcy5leGlzdHNTeW5jKHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCAncmVzb3VyY2VzLycpKSkge1xuICAgICAgdmFyIGZyb21SZXNvdXJjZXMgPSBwYXRoLmpvaW4ocHJvY2Vzcy5jd2QoKSwgJ3Jlc291cmNlcy8nKVxuICAgICAgdmFyIHRvUmVzb3VyY2VzID0gcGF0aC5qb2luKG91dHB1dCwgJy4uL3Jlc291cmNlcycpXG4gICAgICBmc3guY29weVN5bmMoZnJvbVJlc291cmNlcywgdG9SZXNvdXJjZXMpXG4gICAgICBsb2coYXBwICsgJ2NvcHlpbmcgJyArIGZyb21SZXNvdXJjZXMucmVwbGFjZShwcm9jZXNzLmN3ZCgpLCAnJykgKyAnIHRvOiAnICsgdG9SZXNvdXJjZXMucmVwbGFjZShwcm9jZXNzLmN3ZCgpLCAnJykpXG4gICAgfVxuXG4gICAgaWYgKGZzLmV4aXN0c1N5bmMocGF0aC5qb2luKHByb2Nlc3MuY3dkKCksIG9wdGlvbnMub3V0cHV0ICsgJy9vdmVycmlkZXMvJykpKSB7XG4gICAgICB2YXIgZnJvbU92ZXJyaWRlcyA9IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCBvcHRpb25zLm91dHB1dCArICcvb3ZlcnJpZGVzLycpXG4gICAgICB2YXIgdG9PdmVycmlkZXMgPSBwYXRoLmpvaW4ob3V0cHV0LCAnb3ZlcnJpZGVzLycpXG4gICAgICBmc3guY29weVN5bmMoZnJvbU92ZXJyaWRlcywgdG9PdmVycmlkZXMpXG4gICAgICBsb2coYXBwICsgJ2NvcHlpbmcgJyArIGZyb21PdmVycmlkZXMucmVwbGFjZShwcm9jZXNzLmN3ZCgpLCAnJykgKyAnIHRvOiAnICsgdG9PdmVycmlkZXMucmVwbGFjZShwcm9jZXNzLmN3ZCgpLCAnJykpXG4gICAgfVxuICB9XG4gIHZhcnMuZmlyc3RUaW1lID0gZmFsc2VcbiAgbGV0IGpzXG4gIGlmICh2YXJzLnByb2R1Y3Rpb24pIHtcbiAgICB2YXJzLmRlcHMucHVzaCgnRXh0LnJlcXVpcmUoXCJFeHQubGF5b3V0LipcIik7XFxuJylcbiAgICBqcyA9IHZhcnMuZGVwcy5qb2luKCc7XFxuJyk7XG4gIH1cbiAgZWxzZSB7XG4gICAganMgPSAnRXh0LnJlcXVpcmUoXCJFeHQuKlwiKSdcbiAgfVxuICBpZiAodmFycy5tYW5pZmVzdCA9PT0gbnVsbCB8fCBqcyAhPT0gdmFycy5tYW5pZmVzdCkge1xuICAgIHZhcnMubWFuaWZlc3QgPSBqc1xuICAgIGNvbnN0IG1hbmlmZXN0ID0gcGF0aC5qb2luKG91dHB1dCwgJ21hbmlmZXN0LmpzJylcbiAgICBmcy53cml0ZUZpbGVTeW5jKG1hbmlmZXN0LCBqcywgJ3V0ZjgnKVxuICAgIHZhcnMucmVidWlsZCA9IHRydWVcbiAgICBsb2coYXBwICsgJ2J1aWxkaW5nIEV4dFJlYWN0IGJ1bmRsZSBhdDogJyArIG91dHB1dC5yZXBsYWNlKHByb2Nlc3MuY3dkKCksICcnKSlcbiAgfVxuICBlbHNlIHtcbiAgICB2YXJzLnJlYnVpbGQgPSBmYWxzZVxuICAgIGxvZyhhcHAgKyAnRXh0UmVhY3QgcmVidWlsZCBOT1QgbmVlZGVkJylcbiAgfVxufVxuXG5cblxuZXhwb3J0IGZ1bmN0aW9uIF9idWlsZEV4dEJ1bmRsZShjb21waWxhdGlvbiwgY21kRXJyb3JzLCBvdXRwdXQsIHBhcm1zLCBvcHRpb25zKSB7XG4gIGxldCBzZW5jaGEgPSBfZ2V0U2VuY2hDbWRQYXRoKClcblxuIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICBjb25zdCBvbkJ1aWxkRG9uZSA9ICgpID0+IHtcbiAgICAgaWYgKGNtZEVycm9ycy5sZW5ndGgpIHtcbiAgICAgICByZWplY3QobmV3IEVycm9yKGNtZEVycm9ycy5qb2luKFwiXCIpKSlcbiAgICAgfSBlbHNlIHtcbiAgICAgICByZXNvbHZlKClcbiAgICAgfVxuICAgfVxuXG4gICB2YXIgb3B0cyA9IHsgY3dkOiBvdXRwdXQsIHNpbGVudDogdHJ1ZSwgc3RkaW86ICdwaXBlJywgZW5jb2Rpbmc6ICd1dGYtOCd9XG4gICBleGVjdXRlQXN5bmMoc2VuY2hhLCBwYXJtcywgb3B0cywgY29tcGlsYXRpb24sIGNtZEVycm9ycywgb3B0aW9ucy52ZXJib3NlKS50aGVuIChcbiAgICAgZnVuY3Rpb24oKSB7IG9uQnVpbGREb25lKCkgfSwgXG4gICAgIGZ1bmN0aW9uKHJlYXNvbikgeyByZXNvbHZlKHJlYXNvbikgfVxuICAgKVxuIH0pXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBleGVjdXRlQXN5bmMgKGNvbW1hbmQsIHBhcm1zLCBvcHRpb25zLCBjb21waWxhdGlvbiwgY21kRXJyb3JzLCB2ZXJib3NlID0gJ25vJywgc3Vic3RyaW5ncyA9IERFRkFVTFRfU1VCU1RSUyApIHtcbiAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGlmKHZlcmJvc2UgPT0gJ3llcycpIHtcbiAgICAgIGNvbnNvbGUubG9nKGAtdi0ke2FwcH0gY29tbWFuZCAtICR7Y29tbWFuZH1gKSBcbiAgICAgIGNvbnNvbGUubG9nKGAtdi0ke2FwcH0gcGFybXMgLSAke3Bhcm1zfWApIFxuICAgICAgY29uc29sZS5sb2coYC12LSR7YXBwfSBvcHRpb25zIC0gJHtKU09OLnN0cmluZ2lmeShvcHRpb25zKX1gKSBcbiAgICB9XG4gICAgbGV0IGNoaWxkID0gY3Jvc3NTcGF3bihjb21tYW5kLCBwYXJtcywgb3B0aW9ucylcbiAgICBjaGlsZC5vbignY2xvc2UnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICBpZihjb2RlID09PSAwKSB7IHJlc29sdmUoMCkgfVxuICAgICAgZWxzZSB7IGNvbXBpbGF0aW9uLmVycm9ycy5wdXNoKCBuZXcgRXJyb3IoY21kRXJyb3JzLmpvaW4oXCJcIikpICk7IHJlamVjdCgwKSB9XG4gICAgfSlcbiAgICBjaGlsZC5vbignZXJyb3InLCAoZXJyb3IpID0+IHsgcmVqZWN0KGVycm9yKSB9KVxuICAgIGNoaWxkLnN0ZG91dC5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICB2YXIgc3RyID0gZGF0YS50b1N0cmluZygpLnJlcGxhY2UoL1xccj9cXG58XFxyL2csIFwiIFwiKS50cmltKClcbiAgICAgIGlmIChkYXRhICYmIGRhdGEudG9TdHJpbmcoKS5tYXRjaCgvV2FpdGluZyBmb3IgY2hhbmdlc1xcLlxcLlxcLi8pKSB7XG4gICAgICAgIHJlc29sdmUoMClcbiAgICAgIH1cbiAgICAgIGlmKHZlcmJvc2UgPT0gJ3llcycpIHtcbiAgICAgICAgY29uc29sZS5sb2coYC12LSR7YXBwfSR7c3RyfWApIFxuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgIGlmIChzdWJzdHJpbmdzLnNvbWUoZnVuY3Rpb24odikgeyByZXR1cm4gZGF0YS5pbmRleE9mKHYpID49IDA7IH0pKSB7IFxuICAgICAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKFwiW0lORl1cIiwgXCJcIilcbiAgICAgICAgICBzdHIgPSBzdHIucmVwbGFjZShcIltMT0ddXCIsIFwiXCIpXG4gICAgICAgICAgc3RyID0gc3RyLnJlcGxhY2UocHJvY2Vzcy5jd2QoKSwgJycpXG4gICAgICAgICAgaWYgKHN0ci5pbmNsdWRlcyhcIltFUlJdXCIpKSB7XG4gICAgICAgICAgICBjbWRFcnJvcnMucHVzaChhcHAgKyBzdHIucmVwbGFjZSgvXlxcW0VSUlxcXSAvZ2ksICcnKSk7XG4gICAgICAgICAgICBzdHIgPSBzdHIucmVwbGFjZShcIltFUlJdXCIsIGAke2NoYWxrLnJlZChcIltFUlJdXCIpfWApXG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnNvbGUubG9nKGAke2FwcH0ke3N0cn1gKSBcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG4gICAgY2hpbGQuc3RkZXJyLm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICAgIHZhciBzdHIgPSBkYXRhLnRvU3RyaW5nKCkucmVwbGFjZSgvXFxyP1xcbnxcXHIvZywgXCIgXCIpLnRyaW0oKVxuICAgICAgdmFyIHN0ckphdmFPcHRzID0gXCJQaWNrZWQgdXAgX0pBVkFfT1BUSU9OU1wiO1xuICAgICAgdmFyIGluY2x1ZGVzID0gc3RyLmluY2x1ZGVzKHN0ckphdmFPcHRzKVxuICAgICAgaWYgKCFpbmNsdWRlcykge1xuICAgICAgICBjb25zb2xlLmxvZyhgJHthcHB9ICR7Y2hhbGsucmVkKFwiW0VSUl1cIil9ICR7c3RyfWApXG4gICAgICB9XG4gICAgfSlcbiAgfSlcbn1cbiJdfQ==