"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getValidateOptions = getValidateOptions;
exports.getDefaultOptions = getDefaultOptions;
exports.getDefaultVars = getDefaultVars;
exports._afterCompile = _afterCompile;
exports._prepareForBuild = _prepareForBuild;

function getValidateOptions() {
  return {
    "type": "object",
    "properties": {
      "framework": {
        "type": ["string"]
      },
      "port": {
        "type": ["integer"]
      },
      "emit": {
        "type": ["boolean"]
      },
      "browser": {
        "type": ["boolean"]
      },
      "profile": {
        "type": ["string"]
      },
      "environment": {
        "type": ["string"]
      },
      "verbose": {
        "type": ["string"]
      }
    },
    "additionalProperties": false // "errorMessage": {
    //   "option": "should be {Boolean} (https:/github.com/org/repo#anchor)"
    // }

  };
}

function getDefaultOptions() {
  return {
    port: 1962,
    emit: true,
    browser: true,
    profile: 'desktop',
    environment: 'development',
    verbose: 'no'
  };
}

function getDefaultVars() {
  return {
    firstTime: true,
    browserCount: 0,
    cwd: process.cwd(),
    extPath: '.',
    pluginErrors: [],
    lastNumFiles: 0,
    lastMilliseconds: 0,
    lastMillisecondsAppJson: 0,
    files: ['./app.json'],
    dirs: ['./app', './packages']
  };
}

function _afterCompile(compilation, vars, options) {
  const logv = require('./pluginUtil').logv;

  logv(options, 'FUNCTION ext-after-compile');

  const path = require('path');

  let {
    files,
    dirs
  } = vars;
  const {
    cwd
  } = vars;
  files = typeof files === 'string' ? [files] : files;
  dirs = typeof dirs === 'string' ? [dirs] : dirs;

  const {
    fileDependencies,
    contextDependencies
  } = _getFileAndContextDeps(compilation, files, dirs, cwd);

  if (files.length > 0) {
    fileDependencies.forEach(file => {
      compilation.fileDependencies.add(path.resolve(file));
    });
  }

  if (dirs.length > 0) {
    contextDependencies.forEach(context => {
      compilation.contextDependencies.add(context);
    });
  }
}

function _getFileAndContextDeps(compilation, files, dirs, cwd) {
  //const log = require('./pluginUtil').log
  const uniq = require('lodash.uniq');

  const isGlob = require('is-glob');

  const {
    fileDependencies,
    contextDependencies
  } = compilation;
  const isWebpack4 = compilation.hooks;
  let fds = isWebpack4 ? [...fileDependencies] : fileDependencies;
  let cds = isWebpack4 ? [...contextDependencies] : contextDependencies;

  if (files.length > 0) {
    files.forEach(pattern => {
      let f = pattern;

      if (isGlob(pattern)) {
        f = glob.sync(pattern, {
          cwd,
          dot: true,
          absolute: true
        });
      }

      fds = fds.concat(f);
    });
    fds = uniq(fds);
  }

  if (dirs.length > 0) {
    cds = uniq(cds.concat(dirs));
  }

  return {
    fileDependencies: fds,
    contextDependencies: cds
  };
}

function _prepareForBuild(app, vars, options, output, compilation) {
  const log = require('./pluginUtil').log;

  const logv = require('./pluginUtil').logv;

  logv(options, '_prepareForBuild');

  const fs = require('fs');

  const recursiveReadSync = require('recursive-readdir-sync');

  var watchedFiles = [];

  try {
    watchedFiles = recursiveReadSync('./app').concat(recursiveReadSync('./packages'));
  } catch (err) {
    if (err.errno === 34) {
      console.log('Path does not exist');
    } else {
      throw err;
    }
  }

  var currentNumFiles = watchedFiles.length;
  logv(options, 'watchedFiles: ' + currentNumFiles);
  var doBuild = false;

  for (var file in watchedFiles) {
    if (vars.lastMilliseconds < fs.statSync(watchedFiles[file]).mtimeMs) {
      if (watchedFiles[file].indexOf("scss") != -1) {
        doBuild = true;
        break;
      }
    }
  }

  if (vars.lastMilliseconds < fs.statSync('./app.json').mtimeMs) {
    doBuild = true;
  }

  logv(options, 'doBuild: ' + doBuild);
  vars.lastMilliseconds = new Date().getTime();
  var filesource = 'this file enables client reload';
  compilation.assets[currentNumFiles + 'FilesUnderAppFolder.md'] = {
    source: function () {
      return filesource;
    },
    size: function () {
      return filesource.length;
    } //if(options.verbose == 'yes') {log('-v-' + app + 'currentNumFiles: ' + currentNumFiles)}
    //if(options.verbose == 'yes') {log('-v-' + app + 'vars.lastNumFiles: ' + vars.lastNumFiles)}
    //if(options.verbose == 'yes') {log('-v-' + app + 'doBuild: ' + doBuild)}

  };

  if (currentNumFiles != vars.lastNumFiles || doBuild) {
    vars.rebuild = true;
    log(app + 'building Ext bundle at: ' + output.replace(process.cwd(), ''));
  } else {
    vars.rebuild = false;
  }

  vars.lastNumFiles = currentNumFiles;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9leHRqc1V0aWwuanMiXSwibmFtZXMiOlsiZ2V0VmFsaWRhdGVPcHRpb25zIiwiZ2V0RGVmYXVsdE9wdGlvbnMiLCJwb3J0IiwiZW1pdCIsImJyb3dzZXIiLCJwcm9maWxlIiwiZW52aXJvbm1lbnQiLCJ2ZXJib3NlIiwiZ2V0RGVmYXVsdFZhcnMiLCJmaXJzdFRpbWUiLCJicm93c2VyQ291bnQiLCJjd2QiLCJwcm9jZXNzIiwiZXh0UGF0aCIsInBsdWdpbkVycm9ycyIsImxhc3ROdW1GaWxlcyIsImxhc3RNaWxsaXNlY29uZHMiLCJsYXN0TWlsbGlzZWNvbmRzQXBwSnNvbiIsImZpbGVzIiwiZGlycyIsIl9hZnRlckNvbXBpbGUiLCJjb21waWxhdGlvbiIsInZhcnMiLCJvcHRpb25zIiwibG9ndiIsInJlcXVpcmUiLCJwYXRoIiwiZmlsZURlcGVuZGVuY2llcyIsImNvbnRleHREZXBlbmRlbmNpZXMiLCJfZ2V0RmlsZUFuZENvbnRleHREZXBzIiwibGVuZ3RoIiwiZm9yRWFjaCIsImZpbGUiLCJhZGQiLCJyZXNvbHZlIiwiY29udGV4dCIsInVuaXEiLCJpc0dsb2IiLCJpc1dlYnBhY2s0IiwiaG9va3MiLCJmZHMiLCJjZHMiLCJwYXR0ZXJuIiwiZiIsImdsb2IiLCJzeW5jIiwiZG90IiwiYWJzb2x1dGUiLCJjb25jYXQiLCJfcHJlcGFyZUZvckJ1aWxkIiwiYXBwIiwib3V0cHV0IiwibG9nIiwiZnMiLCJyZWN1cnNpdmVSZWFkU3luYyIsIndhdGNoZWRGaWxlcyIsImVyciIsImVycm5vIiwiY29uc29sZSIsImN1cnJlbnROdW1GaWxlcyIsImRvQnVpbGQiLCJzdGF0U3luYyIsIm10aW1lTXMiLCJpbmRleE9mIiwiRGF0ZSIsImdldFRpbWUiLCJmaWxlc291cmNlIiwiYXNzZXRzIiwic291cmNlIiwic2l6ZSIsInJlYnVpbGQiLCJyZXBsYWNlIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7QUFFTyxTQUFTQSxrQkFBVCxHQUE4QjtBQUNu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QyxPQUE1QyxFQUFxRDtBQUNuRHRDLElBQUFBLElBQUksQ0FBQ2dELE9BQUwsR0FBZSxJQUFmO0FBQ0FsQixJQUFBQSxHQUFHLENBQUNGLEdBQUcsR0FBRywwQkFBTixHQUFtQ0MsTUFBTSxDQUFDb0IsT0FBUCxDQUFlM0QsT0FBTyxDQUFDRCxHQUFSLEVBQWYsRUFBOEIsRUFBOUIsQ0FBcEMsQ0FBSDtBQUNELEdBSEQsTUFJSztBQUNIVyxJQUFBQSxJQUFJLENBQUNnRCxPQUFMLEdBQWUsS0FBZjtBQUNEOztBQUNEaEQsRUFBQUEsSUFBSSxDQUFDUCxZQUFMLEdBQW9CNEMsZUFBcEI7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiXG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRWYWxpZGF0ZU9wdGlvbnMoKSB7XG4gIHJldHVybiB7XG4gICAgXCJ0eXBlXCI6IFwib2JqZWN0XCIsXG4gICAgXCJwcm9wZXJ0aWVzXCI6IHtcbiAgICAgIFwiZnJhbWV3b3JrXCI6ICAge1widHlwZVwiOiBbIFwic3RyaW5nXCIgXX0sXG4gICAgICBcInBvcnRcIjogICAgICAgIHtcInR5cGVcIjogWyBcImludGVnZXJcIiBdfSxcbiAgICAgIFwiZW1pdFwiOiAgICAgICAge1widHlwZVwiOiBbIFwiYm9vbGVhblwiIF19LFxuICAgICAgXCJicm93c2VyXCI6ICAgICB7XCJ0eXBlXCI6IFsgXCJib29sZWFuXCIgXX0sXG4gICAgICBcInByb2ZpbGVcIjogICAgIHtcInR5cGVcIjogWyBcInN0cmluZ1wiIF19LFxuICAgICAgXCJlbnZpcm9ubWVudFwiOiB7XCJ0eXBlXCI6IFsgXCJzdHJpbmdcIiBdfSxcbiAgICAgIFwidmVyYm9zZVwiOiAgICAge1widHlwZVwiOiBbIFwic3RyaW5nXCIgXX1cbiAgICB9LFxuICAgIFwiYWRkaXRpb25hbFByb3BlcnRpZXNcIjogZmFsc2VcbiAgICAvLyBcImVycm9yTWVzc2FnZVwiOiB7XG4gICAgLy8gICBcIm9wdGlvblwiOiBcInNob3VsZCBiZSB7Qm9vbGVhbn0gKGh0dHBzOi9naXRodWIuY29tL29yZy9yZXBvI2FuY2hvcilcIlxuICAgIC8vIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RGVmYXVsdE9wdGlvbnMoKSB7XG4gIHJldHVybiB7XG4gICAgcG9ydDogMTk2MixcbiAgICBlbWl0OiB0cnVlLFxuICAgIGJyb3dzZXI6IHRydWUsXG4gICAgcHJvZmlsZTogJ2Rlc2t0b3AnLCBcbiAgICBlbnZpcm9ubWVudDogJ2RldmVsb3BtZW50JywgXG4gICAgdmVyYm9zZTogJ25vJ1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXREZWZhdWx0VmFycygpIHtcbiAgcmV0dXJuIHtcbiAgICBmaXJzdFRpbWUgOiB0cnVlLFxuICAgIGJyb3dzZXJDb3VudCA6IDAsXG4gICAgY3dkOiBwcm9jZXNzLmN3ZCgpLFxuICAgIGV4dFBhdGg6ICcuJyxcbiAgICBwbHVnaW5FcnJvcnM6IFtdLFxuICAgIGxhc3ROdW1GaWxlczogMCxcbiAgICBsYXN0TWlsbGlzZWNvbmRzOiAwLFxuICAgIGxhc3RNaWxsaXNlY29uZHNBcHBKc29uOiAwLFxuICAgIGZpbGVzOiBbJy4vYXBwLmpzb24nXSxcbiAgICBkaXJzOiBbJy4vYXBwJywnLi9wYWNrYWdlcyddXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF9hZnRlckNvbXBpbGUoY29tcGlsYXRpb24sIHZhcnMsIG9wdGlvbnMpIHtcbiAgY29uc3QgbG9ndiA9IHJlcXVpcmUoJy4vcGx1Z2luVXRpbCcpLmxvZ3ZcbiAgbG9ndihvcHRpb25zLCdGVU5DVElPTiBleHQtYWZ0ZXItY29tcGlsZScpXG4gIGNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcbiAgbGV0IHsgZmlsZXMsIGRpcnMgfSA9IHZhcnNcbiAgY29uc3QgeyBjd2QgfSA9IHZhcnNcbiAgZmlsZXMgPSB0eXBlb2YgZmlsZXMgPT09ICdzdHJpbmcnID8gW2ZpbGVzXSA6IGZpbGVzXG4gIGRpcnMgPSB0eXBlb2YgZGlycyA9PT0gJ3N0cmluZycgPyBbZGlyc10gOiBkaXJzXG4gIGNvbnN0IHtcbiAgICBmaWxlRGVwZW5kZW5jaWVzLFxuICAgIGNvbnRleHREZXBlbmRlbmNpZXMsXG4gIH0gPSBfZ2V0RmlsZUFuZENvbnRleHREZXBzKGNvbXBpbGF0aW9uLCBmaWxlcywgZGlycywgY3dkKTtcbiAgaWYgKGZpbGVzLmxlbmd0aCA+IDApIHtcbiAgICBmaWxlRGVwZW5kZW5jaWVzLmZvckVhY2goKGZpbGUpID0+IHtcbiAgICAgIGNvbXBpbGF0aW9uLmZpbGVEZXBlbmRlbmNpZXMuYWRkKHBhdGgucmVzb2x2ZShmaWxlKSk7XG4gICAgfSlcbiAgfVxuICBpZiAoZGlycy5sZW5ndGggPiAwKSB7XG4gICAgY29udGV4dERlcGVuZGVuY2llcy5mb3JFYWNoKChjb250ZXh0KSA9PiB7XG4gICAgICBjb21waWxhdGlvbi5jb250ZXh0RGVwZW5kZW5jaWVzLmFkZChjb250ZXh0KTtcbiAgICB9KVxuICB9XG59XG5cbmZ1bmN0aW9uIF9nZXRGaWxlQW5kQ29udGV4dERlcHMoY29tcGlsYXRpb24sIGZpbGVzLCBkaXJzLCBjd2QpIHtcbiAgLy9jb25zdCBsb2cgPSByZXF1aXJlKCcuL3BsdWdpblV0aWwnKS5sb2dcbiAgY29uc3QgdW5pcSA9IHJlcXVpcmUoJ2xvZGFzaC51bmlxJylcbiAgY29uc3QgaXNHbG9iID0gcmVxdWlyZSgnaXMtZ2xvYicpXG5cbiAgY29uc3QgeyBmaWxlRGVwZW5kZW5jaWVzLCBjb250ZXh0RGVwZW5kZW5jaWVzIH0gPSBjb21waWxhdGlvbjtcbiAgY29uc3QgaXNXZWJwYWNrNCA9IGNvbXBpbGF0aW9uLmhvb2tzO1xuICBsZXQgZmRzID0gaXNXZWJwYWNrNCA/IFsuLi5maWxlRGVwZW5kZW5jaWVzXSA6IGZpbGVEZXBlbmRlbmNpZXM7XG4gIGxldCBjZHMgPSBpc1dlYnBhY2s0ID8gWy4uLmNvbnRleHREZXBlbmRlbmNpZXNdIDogY29udGV4dERlcGVuZGVuY2llcztcbiAgaWYgKGZpbGVzLmxlbmd0aCA+IDApIHtcbiAgICBmaWxlcy5mb3JFYWNoKChwYXR0ZXJuKSA9PiB7XG4gICAgICBsZXQgZiA9IHBhdHRlcm5cbiAgICAgIGlmIChpc0dsb2IocGF0dGVybikpIHtcbiAgICAgICAgZiA9IGdsb2Iuc3luYyhwYXR0ZXJuLCB7IGN3ZCwgZG90OiB0cnVlLCBhYnNvbHV0ZTogdHJ1ZSB9KVxuICAgICAgfVxuICAgICAgZmRzID0gZmRzLmNvbmNhdChmKVxuICAgIH0pXG4gICAgZmRzID0gdW5pcShmZHMpXG4gIH1cbiAgaWYgKGRpcnMubGVuZ3RoID4gMCkge1xuICAgIGNkcyA9IHVuaXEoY2RzLmNvbmNhdChkaXJzKSlcbiAgfVxuICByZXR1cm4geyBmaWxlRGVwZW5kZW5jaWVzOiBmZHMsIGNvbnRleHREZXBlbmRlbmNpZXM6IGNkcyB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBfcHJlcGFyZUZvckJ1aWxkKGFwcCwgdmFycywgb3B0aW9ucywgb3V0cHV0LCBjb21waWxhdGlvbikge1xuICBjb25zdCBsb2cgPSByZXF1aXJlKCcuL3BsdWdpblV0aWwnKS5sb2dcbiAgY29uc3QgbG9ndiA9IHJlcXVpcmUoJy4vcGx1Z2luVXRpbCcpLmxvZ3ZcbiAgbG9ndihvcHRpb25zLCdfcHJlcGFyZUZvckJ1aWxkJylcbiAgY29uc3QgZnMgPSByZXF1aXJlKCdmcycpXG4gIGNvbnN0IHJlY3Vyc2l2ZVJlYWRTeW5jID0gcmVxdWlyZSgncmVjdXJzaXZlLXJlYWRkaXItc3luYycpXG4gIHZhciB3YXRjaGVkRmlsZXM9W11cbiAgdHJ5IHt3YXRjaGVkRmlsZXMgPSByZWN1cnNpdmVSZWFkU3luYygnLi9hcHAnKS5jb25jYXQocmVjdXJzaXZlUmVhZFN5bmMoJy4vcGFja2FnZXMnKSl9XG4gIGNhdGNoKGVycikge2lmKGVyci5lcnJubyA9PT0gMzQpe2NvbnNvbGUubG9nKCdQYXRoIGRvZXMgbm90IGV4aXN0Jyk7fSBlbHNlIHt0aHJvdyBlcnI7fX1cbiAgdmFyIGN1cnJlbnROdW1GaWxlcyA9IHdhdGNoZWRGaWxlcy5sZW5ndGhcbiAgbG9ndihvcHRpb25zLCd3YXRjaGVkRmlsZXM6ICcgKyBjdXJyZW50TnVtRmlsZXMpXG4gIHZhciBkb0J1aWxkID0gZmFsc2VcbiAgZm9yICh2YXIgZmlsZSBpbiB3YXRjaGVkRmlsZXMpIHtcbiAgICBpZiAodmFycy5sYXN0TWlsbGlzZWNvbmRzIDwgZnMuc3RhdFN5bmMod2F0Y2hlZEZpbGVzW2ZpbGVdKS5tdGltZU1zKSB7XG4gICAgICBpZiAod2F0Y2hlZEZpbGVzW2ZpbGVdLmluZGV4T2YoXCJzY3NzXCIpICE9IC0xKSB7ZG9CdWlsZD10cnVlO2JyZWFrO31cbiAgICB9XG4gIH1cbiAgaWYgKHZhcnMubGFzdE1pbGxpc2Vjb25kcyA8IGZzLnN0YXRTeW5jKCcuL2FwcC5qc29uJykubXRpbWVNcykge1xuICAgIGRvQnVpbGQ9dHJ1ZVxuICB9XG4gIGxvZ3Yob3B0aW9ucywnZG9CdWlsZDogJyArIGRvQnVpbGQpXG5cbiAgdmFycy5sYXN0TWlsbGlzZWNvbmRzID0gKG5ldyBEYXRlKS5nZXRUaW1lKClcbiAgdmFyIGZpbGVzb3VyY2UgPSAndGhpcyBmaWxlIGVuYWJsZXMgY2xpZW50IHJlbG9hZCdcbiAgY29tcGlsYXRpb24uYXNzZXRzW2N1cnJlbnROdW1GaWxlcyArICdGaWxlc1VuZGVyQXBwRm9sZGVyLm1kJ10gPSB7XG4gICAgc291cmNlOiBmdW5jdGlvbigpIHtyZXR1cm4gZmlsZXNvdXJjZX0sXG4gICAgc2l6ZTogZnVuY3Rpb24oKSB7cmV0dXJuIGZpbGVzb3VyY2UubGVuZ3RofVxuICB9XG5cbiAgLy9pZihvcHRpb25zLnZlcmJvc2UgPT0gJ3llcycpIHtsb2coJy12LScgKyBhcHAgKyAnY3VycmVudE51bUZpbGVzOiAnICsgY3VycmVudE51bUZpbGVzKX1cbiAgLy9pZihvcHRpb25zLnZlcmJvc2UgPT0gJ3llcycpIHtsb2coJy12LScgKyBhcHAgKyAndmFycy5sYXN0TnVtRmlsZXM6ICcgKyB2YXJzLmxhc3ROdW1GaWxlcyl9XG4gIC8vaWYob3B0aW9ucy52ZXJib3NlID09ICd5ZXMnKSB7bG9nKCctdi0nICsgYXBwICsgJ2RvQnVpbGQ6ICcgKyBkb0J1aWxkKX1cblxuICBpZiAoY3VycmVudE51bUZpbGVzICE9IHZhcnMubGFzdE51bUZpbGVzIHx8IGRvQnVpbGQpIHtcbiAgICB2YXJzLnJlYnVpbGQgPSB0cnVlXG4gICAgbG9nKGFwcCArICdidWlsZGluZyBFeHQgYnVuZGxlIGF0OiAnICsgb3V0cHV0LnJlcGxhY2UocHJvY2Vzcy5jd2QoKSwgJycpKVxuICB9XG4gIGVsc2Uge1xuICAgIHZhcnMucmVidWlsZCA9IGZhbHNlXG4gIH1cbiAgdmFycy5sYXN0TnVtRmlsZXMgPSBjdXJyZW50TnVtRmlsZXNcbn1cbiJdfQ==