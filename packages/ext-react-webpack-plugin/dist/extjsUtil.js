"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getValidateOptions = getValidateOptions;
exports.getDefaultOptions = getDefaultOptions;
exports.getDefaultVars = getDefaultVars;
exports._afterCompile = _afterCompile;
exports._prepareForBuild = _prepareForBuild;

function getValidateOptions() {
  return {
    "type": "object",
    "properties": {
      "framework": {
        "type": ["string"]
      },
      "port": {
        "type": ["integer"]
      },
      "emit": {
        "type": ["boolean"]
      },
      "browser": {
        "type": ["boolean"]
      },
      "profile": {
        "type": ["string"]
      },
      "environment": {
        "type": ["string"]
      },
      "verbose": {
        "type": ["string"]
      }
    },
    "additionalProperties": false // "errorMessage": {
    //   "option": "should be {Boolean} (https:/github.com/org/repo#anchor)"
    // }

  };
}

function getDefaultOptions() {
  return {
    port: 1962,
    emit: true,
    browser: true,
    profile: 'desktop',
    environment: 'development',
    verbose: 'no'
  };
}

function getDefaultVars() {
  return {
    firstTime: true,
    browserCount: 0,
    cwd: process.cwd(),
    extPath: '.',
    pluginErrors: [],
    lastNumFiles: 0,
    lastMilliseconds: 0,
    lastMillisecondsAppJson: 0,
    files: ['./app.json'],
    dirs: ['./app', './packages']
  };
}

function _afterCompile(compilation, vars, options) {
  try {
    require('./pluginUtil').logv(options, 'FUNCTION ext-after-compile');

    const path = require('path');

    let {
      files,
      dirs
    } = vars;
    const {
      cwd
    } = vars;
    files = typeof files === 'string' ? [files] : files;
    dirs = typeof dirs === 'string' ? [dirs] : dirs;

    const {
      fileDependencies,
      contextDependencies
    } = _getFileAndContextDeps(compilation, files, dirs, cwd);

    if (files.length > 0) {
      fileDependencies.forEach(file => {
        compilation.fileDependencies.add(path.resolve(file));
      });
    }

    if (dirs.length > 0) {
      contextDependencies.forEach(context => {
        compilation.contextDependencies.add(context);
      });
    }
  } catch (e) {
    require('./pluginUtil').logv(options, e);

    compilation.errors.push('_afterCompile: ' + e);
  }
}

function _getFileAndContextDeps(compilation, files, dirs, cwd) {
  require('./pluginUtil').logv(options, 'FUNCTION _getFileAndContextDeps');

  const uniq = require('lodash.uniq');

  const isGlob = require('is-glob');

  const {
    fileDependencies,
    contextDependencies
  } = compilation;
  const isWebpack4 = compilation.hooks;
  let fds = isWebpack4 ? [...fileDependencies] : fileDependencies;
  let cds = isWebpack4 ? [...contextDependencies] : contextDependencies;

  if (files.length > 0) {
    files.forEach(pattern => {
      let f = pattern;

      if (isGlob(pattern)) {
        f = glob.sync(pattern, {
          cwd,
          dot: true,
          absolute: true
        });
      }

      fds = fds.concat(f);
    });
    fds = uniq(fds);
  }

  if (dirs.length > 0) {
    cds = uniq(cds.concat(dirs));
  }

  return {
    fileDependencies: fds,
    contextDependencies: cds
  };
}

function _prepareForBuild(app, vars, options, output, compilation) {
  try {
    const log = require('./pluginUtil').log;

    const logv = require('./pluginUtil').logv;

    logv(options, '_prepareForBuild');

    const fs = require('fs');

    const recursiveReadSync = require('recursive-readdir-sync');

    var watchedFiles = [];

    try {
      watchedFiles = recursiveReadSync('./app').concat(recursiveReadSync('./packages'));
    } catch (err) {
      if (err.errno === 34) {
        console.log('Path does not exist');
      } else {
        throw err;
      }
    }

    var currentNumFiles = watchedFiles.length;
    logv(options, 'watchedFiles: ' + currentNumFiles);
    var doBuild = false;

    for (var file in watchedFiles) {
      if (vars.lastMilliseconds < fs.statSync(watchedFiles[file]).mtimeMs) {
        if (watchedFiles[file].indexOf("scss") != -1) {
          doBuild = true;
          break;
        }
      }
    }

    if (vars.lastMilliseconds < fs.statSync('./app.json').mtimeMs) {
      doBuild = true;
    }

    logv(options, 'doBuild: ' + doBuild);
    vars.lastMilliseconds = new Date().getTime();
    var filesource = 'this file enables client reload';
    compilation.assets[currentNumFiles + 'FilesUnderAppFolder.md'] = {
      source: function () {
        return filesource;
      },
      size: function () {
        return filesource.length;
      }
    };
    logv(options, 'currentNumFiles: ' + currentNumFiles);
    logv(options, 'vars.lastNumFiles: ' + vars.lastNumFiles);
    logv(options, 'doBuild: ' + doBuild);

    if (currentNumFiles != vars.lastNumFiles || doBuild) {
      vars.rebuild = true;
      log(app + 'building Ext bundle at: ' + output.replace(process.cwd(), ''));
    } else {
      vars.rebuild = false;
    }

    vars.lastNumFiles = currentNumFiles;
  } catch (e) {
    require('./pluginUtil').logv(options, e);

    compilation.errors.push('_prepareForBuild: ' + e);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9leHRqc1V0aWwuanMiXSwibmFtZXMiOlsiZ2V0VmFsaWRhdGVPcHRpb25zIiwiZ2V0RGVmYXVsdE9wdGlvbnMiLCJwb3J0IiwiZW1pdCIsImJyb3dzZXIiLCJwcm9maWxlIiwiZW52aXJvbm1lbnQiLCJ2ZXJib3NlIiwiZ2V0RGVmYXVsdFZhcnMiLCJmaXJzdFRpbWUiLCJicm93c2VyQ291bnQiLCJjd2QiLCJwcm9jZXNzIiwiZXh0UGF0aCIsInBsdWdpbkVycm9ycyIsImxhc3ROdW1GaWxlcyIsImxhc3RNaWxsaXNlY29uZHMiLCJsYXN0TWlsbGlzZWNvbmRzQXBwSnNvbiIsImZpbGVzIiwiZGlycyIsIl9hZnRlckNvbXBpbGUiLCJjb21waWxhdGlvbiIsInZhcnMiLCJvcHRpb25zIiwicmVxdWlyZSIsImxvZ3YiLCJwYXRoIiwiZmlsZURlcGVuZGVuY2llcyIsImNvbnRleHREZXBlbmRlbmNpZXMiLCJfZ2V0RmlsZUFuZENvbnRleHREZXBzIiwibGVuZ3RoIiwiZm9yRWFjaCIsImZpbGUiLCJhZGQiLCJyZXNvbHZlIiwiY29udGV4dCIsImUiLCJlcnJvcnMiLCJwdXNoIiwidW5pcSIsImlzR2xvYiIsImlzV2VicGFjazQiLCJob29rcyIsImZkcyIsImNkcyIsInBhdHRlcm4iLCJmIiwiZ2xvYiIsInN5bmMiLCJkb3QiLCJhYnNvbHV0ZSIsImNvbmNhdCIsIl9wcmVwYXJlRm9yQnVpbGQiLCJhcHAiLCJvdXRwdXQiLCJsb2ciLCJmcyIsInJlY3Vyc2l2ZVJlYWRTeW5jIiwid2F0Y2hlZEZpbGVzIiwiZXJyIiwiZXJybm8iLCJjb25zb2xlIiwiY3VycmVudE51bUZpbGVzIiwiZG9CdWlsZCIsInN0YXRTeW5jIiwibXRpbWVNcyIsImluZGV4T2YiLCJEYXRlIiwiZ2V0VGltZSIsImZpbGVzb3VyY2UiLCJhc3NldHMiLCJzb3VyY2UiLCJzaXplIiwicmVidWlsZCIsInJlcGxhY2UiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7OztBQUVPLFNB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aW9uIGdldFZhbGlkYXRlT3B0aW9ucygpIHtcbiAgcmV0dXJuIHtcbiAgICBcInR5cGVcIjogXCJvYmplY3RcIixcbiAgICBcInByb3BlcnRpZXNcIjoge1xuICAgICAgXCJmcmFtZXdvcmtcIjogICB7XCJ0eXBlXCI6IFsgXCJzdHJpbmdcIiBdfSxcbiAgICAgIFwicG9ydFwiOiAgICAgICAge1widHlwZVwiOiBbIFwiaW50ZWdlclwiIF19LFxuICAgICAgXCJlbWl0XCI6ICAgICAgICB7XCJ0eXBlXCI6IFsgXCJib29sZWFuXCIgXX0sXG4gICAgICBcImJyb3dzZXJcIjogICAgIHtcInR5cGVcIjogWyBcImJvb2xlYW5cIiBdfSxcbiAgICAgIFwicHJvZmlsZVwiOiAgICAge1widHlwZVwiOiBbIFwic3RyaW5nXCIgXX0sXG4gICAgICBcImVudmlyb25tZW50XCI6IHtcInR5cGVcIjogWyBcInN0cmluZ1wiIF19LFxuICAgICAgXCJ2ZXJib3NlXCI6ICAgICB7XCJ0eXBlXCI6IFsgXCJzdHJpbmdcIiBdfVxuICAgIH0sXG4gICAgXCJhZGRpdGlvbmFsUHJvcGVydGllc1wiOiBmYWxzZVxuICAgIC8vIFwiZXJyb3JNZXNzYWdlXCI6IHtcbiAgICAvLyAgIFwib3B0aW9uXCI6IFwic2hvdWxkIGJlIHtCb29sZWFufSAoaHR0cHM6L2dpdGh1Yi5jb20vb3JnL3JlcG8jYW5jaG9yKVwiXG4gICAgLy8gfVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXREZWZhdWx0T3B0aW9ucygpIHtcbiAgcmV0dXJuIHtcbiAgICBwb3J0OiAxOTYyLFxuICAgIGVtaXQ6IHRydWUsXG4gICAgYnJvd3NlcjogdHJ1ZSxcbiAgICBwcm9maWxlOiAnZGVza3RvcCcsIFxuICAgIGVudmlyb25tZW50OiAnZGV2ZWxvcG1lbnQnLCBcbiAgICB2ZXJib3NlOiAnbm8nXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldERlZmF1bHRWYXJzKCkge1xuICByZXR1cm4ge1xuICAgIGZpcnN0VGltZSA6IHRydWUsXG4gICAgYnJvd3NlckNvdW50IDogMCxcbiAgICBjd2Q6IHByb2Nlc3MuY3dkKCksXG4gICAgZXh0UGF0aDogJy4nLFxuICAgIHBsdWdpbkVycm9yczogW10sXG4gICAgbGFzdE51bUZpbGVzOiAwLFxuICAgIGxhc3RNaWxsaXNlY29uZHM6IDAsXG4gICAgbGFzdE1pbGxpc2Vjb25kc0FwcEpzb246IDAsXG4gICAgZmlsZXM6IFsnLi9hcHAuanNvbiddLFxuICAgIGRpcnM6IFsnLi9hcHAnLCcuL3BhY2thZ2VzJ11cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gX2FmdGVyQ29tcGlsZShjb21waWxhdGlvbiwgdmFycywgb3B0aW9ucykge1xuICB0cnkge1xuICAgIHJlcXVpcmUoJy4vcGx1Z2luVXRpbCcpLmxvZ3Yob3B0aW9ucywnRlVOQ1RJT04gZXh0LWFmdGVyLWNvbXBpbGUnKVxuICAgIGNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcbiAgICBsZXQgeyBmaWxlcywgZGlycyB9ID0gdmFyc1xuICAgIGNvbnN0IHsgY3dkIH0gPSB2YXJzXG4gICAgZmlsZXMgPSB0eXBlb2YgZmlsZXMgPT09ICdzdHJpbmcnID8gW2ZpbGVzXSA6IGZpbGVzXG4gICAgZGlycyA9IHR5cGVvZiBkaXJzID09PSAnc3RyaW5nJyA/IFtkaXJzXSA6IGRpcnNcbiAgICBjb25zdCB7XG4gICAgICBmaWxlRGVwZW5kZW5jaWVzLFxuICAgICAgY29udGV4dERlcGVuZGVuY2llcyxcbiAgICB9ID0gX2dldEZpbGVBbmRDb250ZXh0RGVwcyhjb21waWxhdGlvbiwgZmlsZXMsIGRpcnMsIGN3ZCk7XG4gICAgaWYgKGZpbGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIGZpbGVEZXBlbmRlbmNpZXMuZm9yRWFjaCgoZmlsZSkgPT4ge1xuICAgICAgICBjb21waWxhdGlvbi5maWxlRGVwZW5kZW5jaWVzLmFkZChwYXRoLnJlc29sdmUoZmlsZSkpO1xuICAgICAgfSlcbiAgICB9XG4gICAgaWYgKGRpcnMubGVuZ3RoID4gMCkge1xuICAgICAgY29udGV4dERlcGVuZGVuY2llcy5mb3JFYWNoKChjb250ZXh0KSA9PiB7XG4gICAgICAgIGNvbXBpbGF0aW9uLmNvbnRleHREZXBlbmRlbmNpZXMuYWRkKGNvbnRleHQpO1xuICAgICAgfSlcbiAgICB9XG4gIH1cbiAgY2F0Y2goZSkge1xuICAgIHJlcXVpcmUoJy4vcGx1Z2luVXRpbCcpLmxvZ3Yob3B0aW9ucyxlKVxuICAgIGNvbXBpbGF0aW9uLmVycm9ycy5wdXNoKCdfYWZ0ZXJDb21waWxlOiAnICsgZSlcbiAgfVxufVxuXG5mdW5jdGlvbiBfZ2V0RmlsZUFuZENvbnRleHREZXBzKGNvbXBpbGF0aW9uLCBmaWxlcywgZGlycywgY3dkKSB7XG4gIHJlcXVpcmUoJy4vcGx1Z2luVXRpbCcpLmxvZ3Yob3B0aW9ucywnRlVOQ1RJT04gX2dldEZpbGVBbmRDb250ZXh0RGVwcycpXG4gIGNvbnN0IHVuaXEgPSByZXF1aXJlKCdsb2Rhc2gudW5pcScpXG4gIGNvbnN0IGlzR2xvYiA9IHJlcXVpcmUoJ2lzLWdsb2InKVxuXG4gIGNvbnN0IHsgZmlsZURlcGVuZGVuY2llcywgY29udGV4dERlcGVuZGVuY2llcyB9ID0gY29tcGlsYXRpb247XG4gIGNvbnN0IGlzV2VicGFjazQgPSBjb21waWxhdGlvbi5ob29rcztcbiAgbGV0IGZkcyA9IGlzV2VicGFjazQgPyBbLi4uZmlsZURlcGVuZGVuY2llc10gOiBmaWxlRGVwZW5kZW5jaWVzO1xuICBsZXQgY2RzID0gaXNXZWJwYWNrNCA/IFsuLi5jb250ZXh0RGVwZW5kZW5jaWVzXSA6IGNvbnRleHREZXBlbmRlbmNpZXM7XG4gIGlmIChmaWxlcy5sZW5ndGggPiAwKSB7XG4gICAgZmlsZXMuZm9yRWFjaCgocGF0dGVybikgPT4ge1xuICAgICAgbGV0IGYgPSBwYXR0ZXJuXG4gICAgICBpZiAoaXNHbG9iKHBhdHRlcm4pKSB7XG4gICAgICAgIGYgPSBnbG9iLnN5bmMocGF0dGVybiwgeyBjd2QsIGRvdDogdHJ1ZSwgYWJzb2x1dGU6IHRydWUgfSlcbiAgICAgIH1cbiAgICAgIGZkcyA9IGZkcy5jb25jYXQoZilcbiAgICB9KVxuICAgIGZkcyA9IHVuaXEoZmRzKVxuICB9XG4gIGlmIChkaXJzLmxlbmd0aCA+IDApIHtcbiAgICBjZHMgPSB1bmlxKGNkcy5jb25jYXQoZGlycykpXG4gIH1cbiAgcmV0dXJuIHsgZmlsZURlcGVuZGVuY2llczogZmRzLCBjb250ZXh0RGVwZW5kZW5jaWVzOiBjZHMgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gX3ByZXBhcmVGb3JCdWlsZChhcHAsIHZhcnMsIG9wdGlvbnMsIG91dHB1dCwgY29tcGlsYXRpb24pIHtcbiAgdHJ5IHtcbiAgICBjb25zdCBsb2cgPSByZXF1aXJlKCcuL3BsdWdpblV0aWwnKS5sb2dcbiAgICBjb25zdCBsb2d2ID0gcmVxdWlyZSgnLi9wbHVnaW5VdGlsJykubG9ndlxuICAgIGxvZ3Yob3B0aW9ucywnX3ByZXBhcmVGb3JCdWlsZCcpXG4gICAgY29uc3QgZnMgPSByZXF1aXJlKCdmcycpXG4gICAgY29uc3QgcmVjdXJzaXZlUmVhZFN5bmMgPSByZXF1aXJlKCdyZWN1cnNpdmUtcmVhZGRpci1zeW5jJylcbiAgICB2YXIgd2F0Y2hlZEZpbGVzPVtdXG4gICAgdHJ5IHt3YXRjaGVkRmlsZXMgPSByZWN1cnNpdmVSZWFkU3luYygnLi9hcHAnKS5jb25jYXQocmVjdXJzaXZlUmVhZFN5bmMoJy4vcGFja2FnZXMnKSl9XG4gICAgY2F0Y2goZXJyKSB7aWYoZXJyLmVycm5vID09PSAzNCl7Y29uc29sZS5sb2coJ1BhdGggZG9lcyBub3QgZXhpc3QnKTt9IGVsc2Uge3Rocm93IGVycjt9fVxuICAgIHZhciBjdXJyZW50TnVtRmlsZXMgPSB3YXRjaGVkRmlsZXMubGVuZ3RoXG4gICAgbG9ndihvcHRpb25zLCd3YXRjaGVkRmlsZXM6ICcgKyBjdXJyZW50TnVtRmlsZXMpXG4gICAgdmFyIGRvQnVpbGQgPSBmYWxzZVxuICAgIGZvciAodmFyIGZpbGUgaW4gd2F0Y2hlZEZpbGVzKSB7XG4gICAgICBpZiAodmFycy5sYXN0TWlsbGlzZWNvbmRzIDwgZnMuc3RhdFN5bmMod2F0Y2hlZEZpbGVzW2ZpbGVdKS5tdGltZU1zKSB7XG4gICAgICAgIGlmICh3YXRjaGVkRmlsZXNbZmlsZV0uaW5kZXhPZihcInNjc3NcIikgIT0gLTEpIHtkb0J1aWxkPXRydWU7YnJlYWs7fVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAodmFycy5sYXN0TWlsbGlzZWNvbmRzIDwgZnMuc3RhdFN5bmMoJy4vYXBwLmpzb24nKS5tdGltZU1zKSB7XG4gICAgICBkb0J1aWxkPXRydWVcbiAgICB9XG4gICAgbG9ndihvcHRpb25zLCdkb0J1aWxkOiAnICsgZG9CdWlsZClcblxuICAgIHZhcnMubGFzdE1pbGxpc2Vjb25kcyA9IChuZXcgRGF0ZSkuZ2V0VGltZSgpXG4gICAgdmFyIGZpbGVzb3VyY2UgPSAndGhpcyBmaWxlIGVuYWJsZXMgY2xpZW50IHJlbG9hZCdcbiAgICBjb21waWxhdGlvbi5hc3NldHNbY3VycmVudE51bUZpbGVzICsgJ0ZpbGVzVW5kZXJBcHBGb2xkZXIubWQnXSA9IHtcbiAgICAgIHNvdXJjZTogZnVuY3Rpb24oKSB7cmV0dXJuIGZpbGVzb3VyY2V9LFxuICAgICAgc2l6ZTogZnVuY3Rpb24oKSB7cmV0dXJuIGZpbGVzb3VyY2UubGVuZ3RofVxuICAgIH1cblxuICAgIGxvZ3Yob3B0aW9ucywnY3VycmVudE51bUZpbGVzOiAnICsgY3VycmVudE51bUZpbGVzKVxuICAgIGxvZ3Yob3B0aW9ucywndmFycy5sYXN0TnVtRmlsZXM6ICcgKyB2YXJzLmxhc3ROdW1GaWxlcylcbiAgICBsb2d2KG9wdGlvbnMsJ2RvQnVpbGQ6ICcgKyBkb0J1aWxkKVxuXG4gICAgaWYgKGN1cnJlbnROdW1GaWxlcyAhPSB2YXJzLmxhc3ROdW1GaWxlcyB8fCBkb0J1aWxkKSB7XG4gICAgICB2YXJzLnJlYnVpbGQgPSB0cnVlXG4gICAgICBsb2coYXBwICsgJ2J1aWxkaW5nIEV4dCBidW5kbGUgYXQ6ICcgKyBvdXRwdXQucmVwbGFjZShwcm9jZXNzLmN3ZCgpLCAnJykpXG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgdmFycy5yZWJ1aWxkID0gZmFsc2VcbiAgICB9XG4gICAgdmFycy5sYXN0TnVtRmlsZXMgPSBjdXJyZW50TnVtRmlsZXNcbiAgfVxuICBjYXRjaChlKSB7XG4gICAgcmVxdWlyZSgnLi9wbHVnaW5VdGlsJykubG9ndihvcHRpb25zLGUpXG4gICAgY29tcGlsYXRpb24uZXJyb3JzLnB1c2goJ19wcmVwYXJlRm9yQnVpbGQ6ICcgKyBlKVxuICB9XG59XG4iXX0=