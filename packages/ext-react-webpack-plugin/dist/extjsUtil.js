"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getValidateOptions = getValidateOptions;
exports.getDefaultOptions = getDefaultOptions;
exports.getDefaultVars = getDefaultVars;
exports._afterCompile = _afterCompile;
exports._prepareForBuild = _prepareForBuild;

function getValidateOptions() {
  return {
    "type": "object",
    "properties": {
      "framework": {
        "type": ["string"]
      },
      "port": {
        "type": ["integer"]
      },
      "emit": {
        "type": ["boolean"]
      },
      "browser": {
        "type": ["boolean"]
      },
      "watch": {
        "type": ["string"]
      },
      "profile": {
        "type": ["string"]
      },
      "environment": {
        "type": ["string"]
      },
      "verbose": {
        "type": ["string"]
      }
    },
    "additionalProperties": false // "errorMessage": {
    //   "option": "should be {Boolean} (https:/github.com/org/repo#anchor)"
    // }

  };
}

function getDefaultOptions() {
  return {
    port: 1962,
    emit: true,
    browser: true,
    watch: 'yes',
    profile: 'desktop',
    environment: 'development',
    verbose: 'no'
  };
}

function getDefaultVars() {
  return {
    watchStarted: false,
    firstTime: true,
    browserCount: 0,
    cwd: process.cwd(),
    extPath: '.',
    pluginErrors: [],
    lastNumFiles: 0,
    lastMilliseconds: 0,
    lastMillisecondsAppJson: 0,
    files: ['./app.json'],
    dirs: ['./app', './packages']
  };
}

function _afterCompile(compilation, vars, options) {
  try {
    require('./pluginUtil').logv(options, 'FUNCTION ext-after-compile');

    const path = require('path');

    let {
      files,
      dirs
    } = vars;
    const {
      cwd
    } = vars;
    files = typeof files === 'string' ? [files] : files;
    dirs = typeof dirs === 'string' ? [dirs] : dirs;

    const {
      fileDependencies,
      contextDependencies
    } = _getFileAndContextDeps(compilation, files, dirs, cwd, options);

    if (files.length > 0) {
      fileDependencies.forEach(file => {
        compilation.fileDependencies.add(path.resolve(file));
      });
    }

    if (dirs.length > 0) {
      contextDependencies.forEach(context => {
        compilation.contextDependencies.add(context);
      });
    }
  } catch (e) {
    console.log(e);
    compilation.errors.push('_afterCompile: ' + e);
  }
}

function _getFileAndContextDeps(compilation, files, dirs, cwd, options) {
  require('./pluginUtil').logv(options, 'FUNCTION _getFileAndContextDeps');

  const uniq = require('lodash.uniq');

  const isGlob = require('is-glob');

  const {
    fileDependencies,
    contextDependencies
  } = compilation;
  const isWebpack4 = compilation.hooks;
  let fds = isWebpack4 ? [...fileDependencies] : fileDependencies;
  let cds = isWebpack4 ? [...contextDependencies] : contextDependencies;

  if (files.length > 0) {
    files.forEach(pattern => {
      let f = pattern;

      if (isGlob(pattern)) {
        f = glob.sync(pattern, {
          cwd,
          dot: true,
          absolute: true
        });
      }

      fds = fds.concat(f);
    });
    fds = uniq(fds);
  }

  if (dirs.length > 0) {
    cds = uniq(cds.concat(dirs));
  }

  return {
    fileDependencies: fds,
    contextDependencies: cds
  };
}

function _prepareForBuild(app, vars, options, output, compilation) {
  try {
    const log = require('./pluginUtil').log;

    const logv = require('./pluginUtil').logv;

    logv(options, '_prepareForBuild');

    const fs = require('fs');

    const recursiveReadSync = require('recursive-readdir-sync');

    var watchedFiles = [];

    try {
      watchedFiles = recursiveReadSync('./app').concat(recursiveReadSync('./packages'));
    } catch (err) {
      if (err.errno === 34) {
        console.log('Path does not exist');
      } else {
        throw err;
      }
    }

    var currentNumFiles = watchedFiles.length;
    logv(options, 'watchedFiles: ' + currentNumFiles);
    var doBuild = true; // var doBuild = false
    // for (var file in watchedFiles) {
    //   if (vars.lastMilliseconds < fs.statSync(watchedFiles[file]).mtimeMs) {
    //     if (watchedFiles[file].indexOf("scss") != -1) {doBuild=true;break;}
    //   }
    // }
    // if (vars.lastMilliseconds < fs.statSync('./app.json').mtimeMs) {
    //   doBuild=true
    // }

    logv(options, 'doBuild: ' + doBuild);
    vars.lastMilliseconds = new Date().getTime();
    var filesource = 'this file enables client reload';
    compilation.assets[currentNumFiles + 'FilesUnderAppFolder.md'] = {
      source: function () {
        return filesource;
      },
      size: function () {
        return filesource.length;
      }
    };
    logv(options, 'currentNumFiles: ' + currentNumFiles);
    logv(options, 'vars.lastNumFiles: ' + vars.lastNumFiles);
    logv(options, 'doBuild: ' + doBuild);

    if (currentNumFiles != vars.lastNumFiles || doBuild) {
      vars.rebuild = true;
      var bundleDir = output.replace(process.cwd(), '');

      if (bundleDir.trim() == '') {
        bundleDir = './';
      }

      log(app + 'Building Ext bundle at: ' + bundleDir);
    } else {
      vars.rebuild = false;
    }

    vars.lastNumFiles = currentNumFiles;
  } catch (e) {
    console.log(e);
    compilation.errors.push('_prepareForBuild: ' + e);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9leHRqc1V0aWwuanMiXSwibmFtZXMiOlsiZ2V0VmFsaWRhdGVPcHRpb25zIiwiZ2V0RGVmYXVsdE9wdGlvbnMiLCJwb3J0IiwiZW1pdCIsImJyb3dzZXIiLCJ3YXRjaCIsInByb2ZpbGUiLCJlbnZpcm9ubWVudCIsInZlcmJvc2UiLCJnZXREZWZhdWx0VmFycyIsIndhdGNoU3RhcnRlZCIsImZpcnN0VGltZSIsImJyb3dzZXJDb3VudCIsImN3ZCIsInByb2Nlc3MiLCJleHRQYXRoIiwicGx1Z2luRXJyb3JzIiwibGFzdE51bUZpbGVzIiwibGFzdE1pbGxpc2Vjb25kcyIsImxhc3RNaWxsaXNlY29uZHNBcHBKc29uIiwiZmlsZXMiLCJkaXJzIiwiX2FmdGVyQ29tcGlsZSIsImNvbXBpbGF0aW9uIiwidmFycyIsIm9wdGlvbnMiLCJyZXF1aXJlIiwibG9ndiIsInBhdGgiLCJmaWxlRGVwZW5kZW5jaWVzIiwiY29udGV4dERlcGVuZGVuY2llcyIsIl9nZXRGaWxlQW5kQ29udGV4dERlcHMiLCJsZW5ndGgiLCJmb3JFYWNoIiwiZmlsZSIsImFkZCIsInJlc29sdmUiLCJjb250ZXh0IiwiZSIsImNvbnNvbGUiLCJsb2ciLCJlcnJvcnMiLCJwdXNoIiwidW5pcSIsImlzR2xvYiIsImlzV2VicGFjazQiLCJob29rcyIsImZkcyIsImNkcyIsInBhdHRlcm4iLCJmIiwiZ2xvYiIsInN5bmMiLCJkb3QiLCJhYnNvbHV0ZSIsImNvbmNhdCIsIl9wcmVwYXJlRm9yQnVpbGQiLCJhcHAiLCJvdXRwdXQiLCJmcyIsInJlY3Vyc2l2ZVJlYWRTeW5jIiwid2F0Y2hlZEZpbGVzIiwiZXJyIiwiZXJybm8iLCJjdXJyZW50TnVtRmlsZXMiLCJkb0J1aWxkIiwiRGF0ZSIsImdldFRpbWUiLCJmaWxlc291cmNlIiwiYXNzZXRzIiwic291cmNlIiwic2l6ZSIsInJlYnVpbGQiLCJidW5kbGVEaXIiLCJyZXBsYWNlIiwidHJpbSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7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QXJDLElBQUFBLElBQUksQ0FBQ0YsT0FBRCxFQUFTLHdCQUF3QkQsSUFBSSxDQUFDUCxZQUF0QyxDQUFKO0FBQ0FVLElBQUFBLElBQUksQ0FBQ0YsT0FBRCxFQUFTLGNBQWN3QyxPQUF2QixDQUFKOztBQUVBLFFBQUlELGVBQWUsSUFBSXhDLElBQUksQ0FBQ1AsWUFBeEIsSUFBd0NnRCxPQUE1QyxFQUFxRDtBQUNuRHpDLE1BQUFBLElBQUksQ0FBQ2dELE9BQUwsR0FBZSxJQUFmO0FBQ0EsVUFBSUMsU0FBUyxHQUFHZixNQUFNLENBQUNnQixPQUFQLENBQWU1RCxPQUFPLENBQUNELEdBQVIsRUFBZixFQUE4QixFQUE5QixDQUFoQjs7QUFDQSxVQUFJNEQsU0FBUyxDQUFDRSxJQUFWLE1BQW9CLEVBQXhCLEVBQTRCO0FBQUNGLFFBQUFBLFNBQVMsR0FBRyxJQUFaO0FBQWlCOztBQUM5Q2pDLE1BQUFBLEdBQUcsQ0FBQ2lCLEdBQUcsR0FBRywwQkFBTixHQUFtQ2dCLFNBQXBDLENBQUg7QUFDRCxLQUxELE1BTUs7QUFDSGpELE1BQUFBLElBQUksQ0FBQ2dELE9BQUwsR0FBZSxLQUFmO0FBQ0Q7O0FBQ0RoRCxJQUFBQSxJQUFJLENBQUNQLFlBQUwsR0FBb0IrQyxlQUFwQjtBQUNELEdBOUNELENBK0NBLE9BQU0xQixDQUFOLEVBQVM7QUFDUEMsSUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVlGLENBQVo7QUFDQWYsSUFBQUEsV0FBVyxDQUFDa0IsTUFBWixDQUFtQkMsSUFBbkIsQ0FBd0IsdUJBQXVCSixDQUEvQztBQUNEO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIlxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0VmFsaWRhdGVPcHRpb25zKCkge1xuICByZXR1cm4ge1xuICAgIFwidHlwZVwiOiBcIm9iamVjdFwiLFxuICAgIFwicHJvcGVydGllc1wiOiB7XG4gICAgICBcImZyYW1ld29ya1wiOiAgIHtcInR5cGVcIjogWyBcInN0cmluZ1wiIF19LFxuICAgICAgXCJwb3J0XCI6ICAgICAgICB7XCJ0eXBlXCI6IFsgXCJpbnRlZ2VyXCIgXX0sXG4gICAgICBcImVtaXRcIjogICAgICAgIHtcInR5cGVcIjogWyBcImJvb2xlYW5cIiBdfSxcbiAgICAgIFwiYnJvd3NlclwiOiAgICAge1widHlwZVwiOiBbIFwiYm9vbGVhblwiIF19LFxuICAgICAgXCJ3YXRjaFwiOiAgICAgICB7XCJ0eXBlXCI6IFsgXCJzdHJpbmdcIiBdfSxcbiAgICAgIFwicHJvZmlsZVwiOiAgICAge1widHlwZVwiOiBbIFwic3RyaW5nXCIgXX0sXG4gICAgICBcImVudmlyb25tZW50XCI6IHtcInR5cGVcIjogWyBcInN0cmluZ1wiIF19LFxuICAgICAgXCJ2ZXJib3NlXCI6ICAgICB7XCJ0eXBlXCI6IFsgXCJzdHJpbmdcIiBdfVxuICAgIH0sXG4gICAgXCJhZGRpdGlvbmFsUHJvcGVydGllc1wiOiBmYWxzZVxuICAgIC8vIFwiZXJyb3JNZXNzYWdlXCI6IHtcbiAgICAvLyAgIFwib3B0aW9uXCI6IFwic2hvdWxkIGJlIHtCb29sZWFufSAoaHR0cHM6L2dpdGh1Yi5jb20vb3JnL3JlcG8jYW5jaG9yKVwiXG4gICAgLy8gfVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXREZWZhdWx0T3B0aW9ucygpIHtcbiAgcmV0dXJuIHtcbiAgICBwb3J0OiAxOTYyLFxuICAgIGVtaXQ6IHRydWUsXG4gICAgYnJvd3NlcjogdHJ1ZSxcbiAgICB3YXRjaDogJ3llcycsXG4gICAgcHJvZmlsZTogJ2Rlc2t0b3AnLCBcbiAgICBlbnZpcm9ubWVudDogJ2RldmVsb3BtZW50JywgXG4gICAgdmVyYm9zZTogJ25vJ1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXREZWZhdWx0VmFycygpIHtcbiAgcmV0dXJuIHtcbiAgICB3YXRjaFN0YXJ0ZWQgOiBmYWxzZSxcbiAgICBmaXJzdFRpbWUgOiB0cnVlLFxuICAgIGJyb3dzZXJDb3VudCA6IDAsXG4gICAgY3dkOiBwcm9jZXNzLmN3ZCgpLFxuICAgIGV4dFBhdGg6ICcuJyxcbiAgICBwbHVnaW5FcnJvcnM6IFtdLFxuICAgIGxhc3ROdW1GaWxlczogMCxcbiAgICBsYXN0TWlsbGlzZWNvbmRzOiAwLFxuICAgIGxhc3RNaWxsaXNlY29uZHNBcHBKc29uOiAwLFxuICAgIGZpbGVzOiBbJy4vYXBwLmpzb24nXSxcbiAgICBkaXJzOiBbJy4vYXBwJywnLi9wYWNrYWdlcyddXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF9hZnRlckNvbXBpbGUoY29tcGlsYXRpb24sIHZhcnMsIG9wdGlvbnMpIHtcbiAgdHJ5IHtcbiAgICByZXF1aXJlKCcuL3BsdWdpblV0aWwnKS5sb2d2KG9wdGlvbnMsJ0ZVTkNUSU9OIGV4dC1hZnRlci1jb21waWxlJylcbiAgICBjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG4gICAgbGV0IHsgZmlsZXMsIGRpcnMgfSA9IHZhcnNcbiAgICBjb25zdCB7IGN3ZCB9ID0gdmFyc1xuICAgIGZpbGVzID0gdHlwZW9mIGZpbGVzID09PSAnc3RyaW5nJyA/IFtmaWxlc10gOiBmaWxlc1xuICAgIGRpcnMgPSB0eXBlb2YgZGlycyA9PT0gJ3N0cmluZycgPyBbZGlyc10gOiBkaXJzXG4gICAgY29uc3Qge1xuICAgICAgZmlsZURlcGVuZGVuY2llcyxcbiAgICAgIGNvbnRleHREZXBlbmRlbmNpZXMsXG4gICAgfSA9IF9nZXRGaWxlQW5kQ29udGV4dERlcHMoY29tcGlsYXRpb24sIGZpbGVzLCBkaXJzLCBjd2QsIG9wdGlvbnMpO1xuICAgIGlmIChmaWxlcy5sZW5ndGggPiAwKSB7XG4gICAgICBmaWxlRGVwZW5kZW5jaWVzLmZvckVhY2goKGZpbGUpID0+IHtcbiAgICAgICAgY29tcGlsYXRpb24uZmlsZURlcGVuZGVuY2llcy5hZGQocGF0aC5yZXNvbHZlKGZpbGUpKTtcbiAgICAgIH0pXG4gICAgfVxuICAgIGlmIChkaXJzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnRleHREZXBlbmRlbmNpZXMuZm9yRWFjaCgoY29udGV4dCkgPT4ge1xuICAgICAgICBjb21waWxhdGlvbi5jb250ZXh0RGVwZW5kZW5jaWVzLmFkZChjb250ZXh0KTtcbiAgICAgIH0pXG4gICAgfVxuICB9XG4gIGNhdGNoKGUpIHtcbiAgICBjb25zb2xlLmxvZyhlKVxuICAgIGNvbXBpbGF0aW9uLmVycm9ycy5wdXNoKCdfYWZ0ZXJDb21waWxlOiAnICsgZSlcbiAgfVxufVxuXG5mdW5jdGlvbiBfZ2V0RmlsZUFuZENvbnRleHREZXBzKGNvbXBpbGF0aW9uLCBmaWxlcywgZGlycywgY3dkLCBvcHRpb25zKSB7XG4gIHJlcXVpcmUoJy4vcGx1Z2luVXRpbCcpLmxvZ3Yob3B0aW9ucywnRlVOQ1RJT04gX2dldEZpbGVBbmRDb250ZXh0RGVwcycpXG4gIGNvbnN0IHVuaXEgPSByZXF1aXJlKCdsb2Rhc2gudW5pcScpXG4gIGNvbnN0IGlzR2xvYiA9IHJlcXVpcmUoJ2lzLWdsb2InKVxuXG4gIGNvbnN0IHsgZmlsZURlcGVuZGVuY2llcywgY29udGV4dERlcGVuZGVuY2llcyB9ID0gY29tcGlsYXRpb247XG4gIGNvbnN0IGlzV2VicGFjazQgPSBjb21waWxhdGlvbi5ob29rcztcbiAgbGV0IGZkcyA9IGlzV2VicGFjazQgPyBbLi4uZmlsZURlcGVuZGVuY2llc10gOiBmaWxlRGVwZW5kZW5jaWVzO1xuICBsZXQgY2RzID0gaXNXZWJwYWNrNCA/IFsuLi5jb250ZXh0RGVwZW5kZW5jaWVzXSA6IGNvbnRleHREZXBlbmRlbmNpZXM7XG4gIGlmIChmaWxlcy5sZW5ndGggPiAwKSB7XG4gICAgZmlsZXMuZm9yRWFjaCgocGF0dGVybikgPT4ge1xuICAgICAgbGV0IGYgPSBwYXR0ZXJuXG4gICAgICBpZiAoaXNHbG9iKHBhdHRlcm4pKSB7XG4gICAgICAgIGYgPSBnbG9iLnN5bmMocGF0dGVybiwgeyBjd2QsIGRvdDogdHJ1ZSwgYWJzb2x1dGU6IHRydWUgfSlcbiAgICAgIH1cbiAgICAgIGZkcyA9IGZkcy5jb25jYXQoZilcbiAgICB9KVxuICAgIGZkcyA9IHVuaXEoZmRzKVxuICB9XG4gIGlmIChkaXJzLmxlbmd0aCA+IDApIHtcbiAgICBjZHMgPSB1bmlxKGNkcy5jb25jYXQoZGlycykpXG4gIH1cbiAgcmV0dXJuIHsgZmlsZURlcGVuZGVuY2llczogZmRzLCBjb250ZXh0RGVwZW5kZW5jaWVzOiBjZHMgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gX3ByZXBhcmVGb3JCdWlsZChhcHAsIHZhcnMsIG9wdGlvbnMsIG91dHB1dCwgY29tcGlsYXRpb24pIHtcbiAgdHJ5IHtcbiAgICBjb25zdCBsb2cgPSByZXF1aXJlKCcuL3BsdWdpblV0aWwnKS5sb2dcbiAgICBjb25zdCBsb2d2ID0gcmVxdWlyZSgnLi9wbHVnaW5VdGlsJykubG9ndlxuICAgIGxvZ3Yob3B0aW9ucywnX3ByZXBhcmVGb3JCdWlsZCcpXG4gICAgY29uc3QgZnMgPSByZXF1aXJlKCdmcycpXG4gICAgY29uc3QgcmVjdXJzaXZlUmVhZFN5bmMgPSByZXF1aXJlKCdyZWN1cnNpdmUtcmVhZGRpci1zeW5jJylcbiAgICB2YXIgd2F0Y2hlZEZpbGVzPVtdXG4gICAgdHJ5IHt3YXRjaGVkRmlsZXMgPSByZWN1cnNpdmVSZWFkU3luYygnLi9hcHAnKS5jb25jYXQocmVjdXJzaXZlUmVhZFN5bmMoJy4vcGFja2FnZXMnKSl9XG4gICAgY2F0Y2goZXJyKSB7aWYoZXJyLmVycm5vID09PSAzNCl7Y29uc29sZS5sb2coJ1BhdGggZG9lcyBub3QgZXhpc3QnKTt9IGVsc2Uge3Rocm93IGVycjt9fVxuICAgIHZhciBjdXJyZW50TnVtRmlsZXMgPSB3YXRjaGVkRmlsZXMubGVuZ3RoXG4gICAgbG9ndihvcHRpb25zLCd3YXRjaGVkRmlsZXM6ICcgKyBjdXJyZW50TnVtRmlsZXMpXG4gICAgdmFyIGRvQnVpbGQgPSB0cnVlXG5cbiAgICAvLyB2YXIgZG9CdWlsZCA9IGZhbHNlXG4gICAgLy8gZm9yICh2YXIgZmlsZSBpbiB3YXRjaGVkRmlsZXMpIHtcbiAgICAvLyAgIGlmICh2YXJzLmxhc3RNaWxsaXNlY29uZHMgPCBmcy5zdGF0U3luYyh3YXRjaGVkRmlsZXNbZmlsZV0pLm10aW1lTXMpIHtcbiAgICAvLyAgICAgaWYgKHdhdGNoZWRGaWxlc1tmaWxlXS5pbmRleE9mKFwic2Nzc1wiKSAhPSAtMSkge2RvQnVpbGQ9dHJ1ZTticmVhazt9XG4gICAgLy8gICB9XG4gICAgLy8gfVxuICAgIC8vIGlmICh2YXJzLmxhc3RNaWxsaXNlY29uZHMgPCBmcy5zdGF0U3luYygnLi9hcHAuanNvbicpLm10aW1lTXMpIHtcbiAgICAvLyAgIGRvQnVpbGQ9dHJ1ZVxuICAgIC8vIH1cbiAgICBcbiAgICBsb2d2KG9wdGlvbnMsJ2RvQnVpbGQ6ICcgKyBkb0J1aWxkKVxuXG4gICAgdmFycy5sYXN0TWlsbGlzZWNvbmRzID0gKG5ldyBEYXRlKS5nZXRUaW1lKClcbiAgICB2YXIgZmlsZXNvdXJjZSA9ICd0aGlzIGZpbGUgZW5hYmxlcyBjbGllbnQgcmVsb2FkJ1xuICAgIGNvbXBpbGF0aW9uLmFzc2V0c1tjdXJyZW50TnVtRmlsZXMgKyAnRmlsZXNVbmRlckFwcEZvbGRlci5tZCddID0ge1xuICAgICAgc291cmNlOiBmdW5jdGlvbigpIHtyZXR1cm4gZmlsZXNvdXJjZX0sXG4gICAgICBzaXplOiBmdW5jdGlvbigpIHtyZXR1cm4gZmlsZXNvdXJjZS5sZW5ndGh9XG4gICAgfVxuXG4gICAgbG9ndihvcHRpb25zLCdjdXJyZW50TnVtRmlsZXM6ICcgKyBjdXJyZW50TnVtRmlsZXMpXG4gICAgbG9ndihvcHRpb25zLCd2YXJzLmxhc3ROdW1GaWxlczogJyArIHZhcnMubGFzdE51bUZpbGVzKVxuICAgIGxvZ3Yob3B0aW9ucywnZG9CdWlsZDogJyArIGRvQnVpbGQpXG5cbiAgICBpZiAoY3VycmVudE51bUZpbGVzICE9IHZhcnMubGFzdE51bUZpbGVzIHx8IGRvQnVpbGQpIHtcbiAgICAgIHZhcnMucmVidWlsZCA9IHRydWVcbiAgICAgIHZhciBidW5kbGVEaXIgPSBvdXRwdXQucmVwbGFjZShwcm9jZXNzLmN3ZCgpLCAnJylcbiAgICAgIGlmIChidW5kbGVEaXIudHJpbSgpID09ICcnKSB7YnVuZGxlRGlyID0gJy4vJ31cbiAgICAgIGxvZyhhcHAgKyAnQnVpbGRpbmcgRXh0IGJ1bmRsZSBhdDogJyArIGJ1bmRsZURpcilcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICB2YXJzLnJlYnVpbGQgPSBmYWxzZVxuICAgIH1cbiAgICB2YXJzLmxhc3ROdW1GaWxlcyA9IGN1cnJlbnROdW1GaWxlc1xuICB9XG4gIGNhdGNoKGUpIHtcbiAgICBjb25zb2xlLmxvZyhlKVxuICAgIGNvbXBpbGF0aW9uLmVycm9ycy5wdXNoKCdfcHJlcGFyZUZvckJ1aWxkOiAnICsgZSlcbiAgfVxufVxuIl19